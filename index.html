<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akuntansi Pintar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <style>
        /* --- Variabel Warna Emas Modern & Professional --- */
        :root {
            --primary-gold: #B8860B; /* Dark Goldenrod */
            --primary-dark-gold: #8B6914; /* Darker Gold */
            --light-gold: #FFD700; /* Gold */
            --accent-gold: #FFC107; /* Amber Gold */
            --text-color: #4A4A4A; /* Dark Gray for text */
            --light-text-color: #8C8C8C; /* Lighter Gray for subtle text */
            --light-bg: #F8F8F8; /* Very light gray for backgrounds */
            --dark-bg: #EAEAEA; /* Slightly darker gray for subtle accents */
            --card-bg: #FFFFFF; /* White for cards */
            --border-color: #D3D3D3; /* Light gray for borders */
            --danger-color: #E74C3C; /* Red */
            --success-color: #27AE60; /* Green */
            --info-color: #3498DB; /* Blue */
            --warning-color: #F1C40F; /* Yellow */
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-dark: rgba(0, 0, 0, 0.25);

            /* Gradients (Updated for Gold) */
            --header-gradient: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-dark-gold) 100%);
            --button-primary-gradient: linear-gradient(45deg, var(--light-gold), var(--primary-gold));
            --button-success-gradient: linear-gradient(45deg, var(--success-color), #208b4e);
            --button-danger-gradient: linear-gradient(45deg, var(--danger-color), #c0392b);
            --button-secondary-gradient: linear-gradient(45deg, var(--accent-gold), #e0a300); /* Adjusted secondary */
        }

        /* --- Reset & Base Styles --- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: var(--header-gradient);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 8px 16px var(--shadow-dark);
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="%23ffffff" fill-opacity="0.05" fill-rule="evenodd"><path d="M0 60V0h60v60zM30 0L0 30l30 30L60 30z" fill-rule="nonzero"/></g></svg>');
            opacity: 0.2;
            pointer-events: none;
            z-index: 1;
        }

        header h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 4.5em; /* Diperbesar */
            font-weight: 800;
            letter-spacing: 0.12em; /* Diperjelas */
            /* Updated for shiny gold gradient */
            background: linear-gradient(
                45deg,
                #FFD700 0%,     /* Bright Gold */
                #DAA520 25%,    /* Goldenrod */
                #B8860B 50%,    /* Dark Goldenrod */
                #DAA520 75%,    /* Goldenrod */
                #FFD700 100%    /* Bright Gold */
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support -webkit-text-fill-color */
            text-shadow: 2px 2px 5px var(--shadow-dark);
            position: relative;
            z-index: 2;
        }

        .app-creator { /* This class is now unused in HTML but kept in CSS for completeness */
            font-size: 1em;
            font-weight: 400;
            margin-top: 10px;
            opacity: 0.8;
            position: relative;
            z-index: 2;
        }

        /* --- Main Container --- */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px;
            max-width: 1400px;
            margin: 30px auto;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-medium);
        }

        /* --- Tab Navigation --- */
        .tab-navigation {
            display: flex;
            border-bottom: 3px solid var(--border-color);
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background-color: var(--dark-bg);
            border-radius: 8px;
            padding: 5px;
        }
        .tab-navigation::-webkit-scrollbar { display: none; }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 18px 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--light-text-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: var(--primary-gold);
            background-color: rgba(184, 134, 11, 0.08); /* RGB of primary-gold */
        }

        .tab-button.active {
            color: var(--text-color); /* Changed to dark text for gold background */
            background: var(--button-primary-gradient);
            box-shadow: 0 4px 10px var(--shadow-light);
            transform: translateY(-2px);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--accent-gold);
        }

        /* --- Tab Content --- */
        .tab-content {
            display: none;
            padding: 20px 0;
            flex-direction: column;
            flex: 1;
            animation: fadeIn 0.5s ease-out;
        }
        .tab-content.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Section Titles (H2) --- */
        h2 {
            color: var(--primary-dark-gold); /* Darker gold for headers */
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
            border-bottom: 4px solid var(--border-color);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 svg {
            color: var(--accent-gold);
            font-size: 1.3em;
        }

        /* --- Kasir Layout --- */
        .kasir-layout {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 35px;
            flex: 1;
        }

        .left-panel, .right-panel {
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--light-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 22px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1em;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"], /* Added for user management */
        input[type="date"], /* For expense and potentially other date inputs */
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.05em;
            box-sizing: border-box;
            background-color: var(--card-bg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-gold); /* Gold focus */
            box-shadow: 0 0 0 4px rgba(184, 134, 11, 0.25); /* Gold focus ring */
            outline: none;
        }
        input[readonly] {
            background-color: var(--dark-bg);
            cursor: not-allowed;
            opacity: 0.8;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* --- Button Group --- */
        .button-group {
            display: flex;
            gap: 18px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .modal .button-group, .transaction-detail .button-group {
            justify-content: center;
        }
        .login-modal-content .button-group {
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 14px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px var(--shadow-light);
            color: white; /* Default to white text for most buttons */
        }

        button.primary { background: var(--button-primary-gradient); color: var(--text-color); } /* Dark text on gold */
        button.primary:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.secondary { background: var(--button-secondary-gradient); color: var(--text-color); } /* Dark text on amber gold */
        button.secondary:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.danger { background: var(--button-danger-gradient); }
        button.danger:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.success { background: var(--button-success-gradient); }
        button.success:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.info { background-color: var(--info-color); }
        button.info:hover { background-color: #217dbb; transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.warning { background-color: var(--warning-color); color: var(--text-color); } /* Dark text on yellow */
        button.warning:hover { background-color: #d8af11; transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        /* --- Cart Items Display --- */
        .cart-items {
            flex: 1;
            margin-bottom: 30px;
            overflow-y: auto;
            max-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--dark-bg);
            transition: background-color 0.2s ease;
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item:hover { background-color: var(--dark-bg); }

        .cart-item-info { flex-grow: 1; margin-right: 20px; }
        .cart-item-name { font-weight: 700; color: var(--primary-gold); font-size: 1.1em; } /* Gold product name */
        .cart-item-quantity, .cart-item-price-per-item { font-size: 0.9em; color: var(--light-text-color); }
        .cart-item-total-price { font-weight: 700; color: var(--success-color); white-space: nowrap; font-size: 1.2em; }
        .cart-item-actions button {
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 6px;
            box-shadow: none;
            transform: none;
        }
        .cart-item-actions button:hover { opacity: 0.8; }
        .empty-cart-message, .empty-table-message, .empty-chart-message {
            text-align: center;
            color: var(--light-text-color);
            padding: 40px;
            font-style: italic;
            font-size: 1.1em;
        }

        /* --- Cart Summary --- */
        .cart-summary {
            margin-top: auto;
            border-top: 3px solid var(--primary-gold); /* Gold border top */
            padding-top: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.15em;
            color: var(--text-color);
            font-weight: 500;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.8em;
            color: var(--primary-dark-gold); /* Darker gold for total */
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            margin-top: 20px;
        }
        .summary-row.change-negative { color: var(--danger-color); }
        .summary-row.change-positive { color: var(--success-color); }


        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        table thead th {
            background: var(--header-gradient);
            color: white;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 2px solid var(--primary-dark-gold); /* Darker gold border */
            font-weight: 600;
            font-size: 1em;
        }

        table tbody td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 0.95em;
        }

        table tbody tr:nth-child(even) { background-color: var(--light-bg); }
        table tbody tr:hover { background-color: var(--dark-bg); transition: background-color 0.2s ease; }

        .table-actions { display: flex; gap: 10px; }
        .table-actions button {
            padding: 9px 15px;
            font-size: 0.85em;
            box-shadow: none;
            transform: none;
        }
        .table-actions button:hover { opacity: 0.8; }

        /* --- Notification Area --- */
        #notification-area {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 16px 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-dark);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut var(--notification-duration) forwards;
            animation-delay: 0s, calc(var(--notification-duration) - 0.5s);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }
        .notification::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.4);
            animation: progressBar var(--notification-duration) linear forwards;
        }
        @keyframes progressBar { from { width: 100%; } to { width: 0%; } }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error   { background-color: var(--danger-color); }
        .notification.info    { background-color: var(--info-color); }
        .notification.warning { background-color: var(--warning-color); color: var(--text-color); }

        /* --- Footer --- */
        footer {
            background-color: var(--text-color);
            color: white;
            text-align: center;
            padding: 25px 0;
            margin-top: 50px;
            font-size: 0.95em;
            box-shadow: 0 -5px 15px var(--shadow-medium);
            flex-shrink: 0;
        }
        footer a {
            color: var(--light-gold); /* Warna emas untuk link di footer */
            text-decoration: none;
            transition: color 0.2s ease;
        }
        footer a:hover {
            color: var(--accent-gold);
            text-decoration: underline;
        }


        /* --- Modal Styles --- */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active { opacity: 1; visibility: visible; }

        .modal-content {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 15px 40px var(--shadow-dark);
            position: relative;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.active .modal-content { transform: translateY(0); opacity: 1; }

        .close-button {
            color: var(--light-text-color);
            font-size: 35px;
            font-weight: bold;
            position: absolute;
            top: 20px;
            right: 25px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover { color: var(--danger-color); }

        .modal-content h3 {
            color: var(--primary-gold); /* Gold modal header */
            margin-top: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            font-size: 2em;
        }
        .modal-content ul {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--light-bg);
        }
        .modal-content ul li {
            padding: 10px 15px;
            border-bottom: 1px dashed var(--dark-bg);
            font-size: 0.95em;
            color: var(--text-color);
        }
        .modal-content ul li:last-child { border-bottom: none; }

        .modal-content .summary-row {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .modal-content .summary-row.total {
            font-size: 1.4em;
        }

        /* --- Rekapan Section Styles --- */
        .recap-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted for more cards */
            gap: 30px;
            margin-top: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--light-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .recap-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-light);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .recap-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px var(--shadow-medium);
        }

        .recap-card h3 {
            color: var(--light-text-color);
            font-size: 1.4em;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            text-align: center;
        }

        .recap-card .amount {
            font-size: 3.2em;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            color: var(--primary-gold); /* Gold amount */
            margin-bottom: 0;
            line-height: 1.2;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .recap-card.expense .amount { color: var(--danger-color); }
        .recap-card.profit .amount { color: var(--success-color); }

        .chart-container {
            margin-top: 40px;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-light);
            max-width: 100%;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }
        .chart-message {
            text-align: center;
            color: var(--light-text-color);
            padding: 20px;
            font-style: italic;
        }

        /* Pengaturan tab specific styles */
        .settings-section {
            background-color: var(--light-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.03);
        }
        .settings-section h3 {
            color: var(--primary-dark-gold);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .settings-info {
            font-size: 0.95em;
            color: var(--light-text-color);
            margin-top: -15px;
            margin-bottom: 20px;
        }
        .settings-section .button-group {
            margin-top: 20px;
            justify-content: flex-start;
        }

        /* Login Modal specific styles */
        .login-modal-content {
            max-width: 450px;
            text-align: center;
        }
        .login-modal-content h3 {
            font-size: 2.5em;
            color: var(--primary-dark-gold);
            border-bottom: none;
            margin-bottom: 10px;
        }
        .login-modal-content .company-name {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-bottom: 30px;
        }
        .login-modal-content .form-group {
            text-align: left;
        }
        .login-modal-content label {
            font-size: 1em;
        }
        .login-modal-content input {
            padding: 16px 20px;
            font-size: 1.1em;
            border-radius: 10px;
        }
        .login-modal-content button {
            width: 100%;
            padding: 16px;
            font-size: 1.2em;
        }
        .login-modal-content .info-text {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 25px;
        }


        /* Print Receipt Style */
        @media print {
            body { background-color: white; margin: 0; padding: 0; color: #000; }
            header, footer, .container, .tab-navigation, #notification-area, .modal, button, .button-group, .settings-section { display: none !important; }
            .print-receipt-content {
                display: block !important;
                font-family: 'Consolas', 'Monospace', monospace;
                font-size: 12px;
                line-height: 1.4;
                width: 300px;
                margin: 0 auto;
                padding: 10px;
                box-sizing: border-box;
            }
            .print-receipt-content .header, .print-receipt-content .footer { text-align: center; margin-bottom: 10px; }
            .print-receipt-content .separator { border-top: 1px dashed #000; margin: 8px 0; }
            .print-receipt-content .item-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
            .print-receipt-content .item-name { flex-grow: 1; padding-right: 5px; }
            .print-receipt-content .item-qty-price { white-space: nowrap; text-align: right; }
            .print-receipt-content .summary-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
            .print-receipt-content .total-row { font-size: 1.1em; border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; }
            .print-receipt-content .text-right { text-align: right; }
            /* Logo specific styles for print */
            .print-receipt-content .receipt-logo-container { text-align: center; margin-bottom: 10px; }
            .print-receipt-content #receipt-logo { display: block; max-width: 100px; max-height: 80px; margin: 0 auto; }
        }

        /* --- Media Queries (Responsive Design) --- */
        @media (max-width: 1024px) {
            .kasir-layout { grid-template-columns: 1fr; }
            .left-panel, .right-panel { margin-bottom: 25px; }
            .tab-button { padding: 15px 25px; font-size: 1em; }
            header h1 { font-size: 3.8em; } /* Penyesuaian responsif */
            h2 { font-size: 2em; }
            .recap-summary { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
            .recap-card .amount { font-size: 2.8em; }
        }

        @media (max-width: 768px) {
            .container { margin: 20px; padding: 20px; }
            header h1 { font-size: 3em; } /* Penyesuaian responsif */
            .app-creator { font-size: 0.9em; }
            h2 { font-size: 1.8em; margin-bottom: 25px; }
            .tab-navigation { flex-wrap: wrap; justify-content: center; padding: 3px; }
            .tab-button { flex-basis: 49%; margin: 2px; padding: 12px 20px; font-size: 0.95em; }
            input[type="text"], input[type="number"], select, textarea { padding: 12px 15px; font-size: 0.95em; }
            button { padding: 12px 20px; font-size: 0.95em; }
            .button-group { gap: 12px; margin-top: 20px; }
            .recap-summary { grid-template-columns: 1fr; }
            .recap-card .amount { font-size: 2.5em; }
            .recap-card h3 { font-size: 1.2em; }
            .cart-item { flex-wrap: wrap; gap: 8px; padding: 12px 15px; }
            .cart-item-name { flex-basis: 100%; }
            .cart-item-info, .cart-item-total-price, .cart-item-actions { flex-grow: 1; flex-basis: auto; }
            .cart-item-actions { justify-content: flex-end; }
            .summary-row { font-size: 1em; }
            .summary-row.total { font-size: 1.5em; }
            .modal-content { padding: 30px; }
            .modal-content h3 { font-size: 1.6em; }
        }

        @media (max-width: 480px) {
            header h1 { font-size: 2.5em; } /* Penyesuaian responsif */
            .container { margin: 10px; padding: 15px; }
            h2 { font-size: 1.6em; }
            .tab-button { flex-basis: 100%; }
            .notification { max-width: 90%; right: 5%; left: 5%; }
            .recap-card .amount { font-size: 2em; }
            .recap-card h3 { font-size: 1.2em; }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="app-company-name">Akuntansi Pintar</h1>
    </header>

    <main class="container">
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="kasir">
                <i data-feather="shopping-cart"></i> Kasir
            </button>
            <button class="tab-button" data-tab="produk">
                <i data-feather="box"></i> Produk
            </button>
            <button class="tab-button" data-tab="pengeluaran">
                <i data-feather="dollar-sign"></i> Pengeluaran
            </button>
            <button class="tab-button" data-tab="laporan">
                <i data-feather="file-text"></i> Laporan Penjualan
            </button>
            <button class="tab-button" data-tab="rekapan">
                <i data-feather="pie-chart"></i> Rekapan Keuangan
            </button>
            <button class="tab-button" data-tab="pengaturan">
                <i data-feather="settings"></i> Pengaturan
            </button>
        </nav>

        <div id="kasir" class="tab-content active">
            <div class="kasir-layout">
                <div class="left-panel">
                    <h2><i data-feather="tag"></i> Input Produk</h2>

                    <div class="form-group">
                        <label for="product-select">Pilih Produk:</label>
                        <select id="product-select">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category-filter">Filter Kategori:</label>
                        <select id="category-filter">
                            <option value="">-- Semua Kategori --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-name">Nama Produk:</label>
                        <input type="text" id="product-name" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-price">Harga (Rp):</label>
                        <input type="number" id="product-price" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-stock-display">Sisa Stok:</label>
                        <input type="text" id="product-stock-display" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-quantity">Jumlah:</label>
                        <input type="number" id="product-quantity" value="1" min="1" placeholder="Jumlah produk">
                    </div>
                    <div class="button-group">
                        <button class="primary" id="add-to-cart-btn"><i data-feather="plus-circle"></i> Tambah ke Keranjang</button>
                        <button class="secondary" id="clear-input-btn"><i data-feather="refresh-cw"></i> Bersihkan Input</button>
                    </div>
                </div>

                <div class="right-panel">
                    <h2><i data-feather="shopping-bag"></i> Keranjang Belanja</h2>
                   <div class="cart-items scrollable-container">  <div class="produk-section scrollable-container">
<div class="laporan-section scrollable-container">
                        <p class="empty-cart-message">Keranjang kosong. Pilih produk dari daftar.</p>
                    </div>
                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">Rp 0</span>
                        </div>
                        <div class="form-group">
                            <label for="discount-type">Jenis Diskon:</label>
                            <select id="discount-type">
                                <option value="none">Tidak Ada Diskon</option>
                                <option value="percentage">Persentase (%)</option>
                                <option value="nominal">Nominal (Rp)</option>
                            </select>
                        </div>
                        <div class="form-group" id="discount-value-group" style="display:none;">
                            <label for="discount-value">Nilai Diskon:</label>
                            <input type="number" id="discount-value" value="0" min="0" placeholder="Masukkan nilai diskon">
                        </div>
                        <div class="summary-row">
                            <span>Diskon:</span>
                            <span id="discount">Rp 0</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total Pembayaran:</span>
                            <span id="total-payment">Rp 0</span>
                        </div>
                        <div class="form-group">
                            <label for="amount-paid">Jumlah Dibayar (Rp):</label>
                            <input type="number" id="amount-paid" value="0" min="0" placeholder="Masukkan jumlah uang dibayar">
                        </div>
                        <div class="summary-row total" id="change-row">
                            <span>Kembalian:</span>
                            <span id="change-amount">Rp 0</span>
                        </div>
                        <div class="button-group">
                            <button class="success" id="process-payment-btn"><i data-feather="dollar-sign"></i> Proses Pembayaran</button>
                            <button class="danger" id="clear-cart-btn"><i data-feather="trash-2"></i> Bersihkan Keranjang</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="produk" class="tab-content">
            <h2><i data-feather="database"></i> Manajemen Produk</h2>
            <div class="product-form-container">
                <div class="form-group">
                    <label for="new-product-name">Nama Produk Baru:</label>
                    <input type="text" id="new-product-name" placeholder="Contoh: Kopi Americano">
                </div>
                <div class="form-group">
                    <label for="new-product-category">Kategori:</label>
                    <input type="text" id="new-product-category" placeholder="Contoh: Minuman, Makanan">
                </div>
                <div class="form-group">
                    <label for="new-product-cost-price">Harga Beli (Rp):</label>
                    <input type="number" id="new-product-cost-price" min="0" value="0" placeholder="Harga beli produk">
                </div>
                <div class="form-group">
                    <label for="new-product-price">Harga Jual (Rp):</label>
                    <input type="number" id="new-product-price" min="0" value="0" placeholder="Harga jual produk">
                </div>
                <div class="form-group">
                    <label for="new-product-markup-percentage">Markup (%):</label>
                    <input type="number" id="new-product-markup-percentage" min="0" max="1000" step="0.01" readonly title="Markup dihitung otomatis (Harga Jual - Harga Beli) / Harga Beli * 100">
                </div>
                <div class="form-group">
                    <label for="new-product-stock">Stok Awal:</label>
                    <input type="number" id="new-product-stock" min="0" value="0" placeholder="Jumlah stok awal">
                </div>
                <div class="form-group">
                    <label for="new-product-min-stock">Min. Stok untuk Peringatan:</label>
                    <input type="number" id="new-product-min-stock" min="0" value="0" placeholder="Stok minimum untuk peringatan">
                </div>
                <div class="button-group">
                    <button class="primary" id="add-new-product-btn"><i data-feather="plus"></i> Tambah Produk Baru</button>
                </div>
            </div>

            <table id="product-table">
                <thead>
                    <tr>
                        <th>ID Produk</th>
                        <th>Nama</th>
                        <th>Kategori</th>
                        <th>Harga Beli</th>
                        <th>Harga Jual</th>
                        <th>Markup (%)</th>
                        <th>Stok</th>
                        <th>Min. Stok</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="product-list-body">
                    </tbody>
            </table>
        </div>

        <div id="pengeluaran" class="tab-content">
            <h2><i data-feather="minus-circle"></i> Manajemen Pengeluaran</h2>
            <div class="form-group">
                <label for="expense-date">Tanggal Pengeluaran:</label>
                <input type="date" id="expense-date" required>
            </div>
            <div class="form-group">
                <label for="expense-category">Kategori Pengeluaran:</label>
                <input type="text" id="expense-category" placeholder="Contoh: Sewa, Gaji, Listrik" required>
            </div>
            <div class="form-group">
                <label for="expense-description">Deskripsi:</label>
                <textarea id="expense-description" placeholder="Deskripsi detail pengeluaran" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="expense-amount">Jumlah (Rp):</label>
                <input type="number" id="expense-amount" min="0" value="0" required placeholder="Jumlah pengeluaran">
            </div>
            <div class="button-group">
                <button class="danger" id="add-expense-btn"><i data-feather="plus"></i> Tambah Pengeluaran</button>
            </div>

            <table id="expense-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tanggal</th>
                        <th>Kategori</th>
                        <th>Deskripsi</th>
                        <th>Jumlah (Rp)</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="expense-list-body">
                    <p class="empty-table-message">Belum ada pengeluaran yang tercatat.</p>
                </tbody>
            </table>
        </div>

        <div id="laporan" class="tab-content">
            <h2><i data-feather="clipboard"></i> Laporan Penjualan</h2>
            <div class="form-group">
                <label for="report-date-filter">Filter Tanggal:</label>
                <input type="month" id="report-date-filter" title="Filter laporan berdasarkan bulan dan tahun">
            </div>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>ID Transaksi</th>
                        <th>Tanggal</th>
                        <th>Total</th>
                        <th>Diskon</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="transaction-list-body">
                    </tbody>
            </table>
        </div>

        <div id="rekapan" class="tab-content">
            <h2><i data-feather="pie-chart"></i> Rekapan Keuangan Keseluruhan</h2>
            <div class="recap-summary" id="recap-summary-content">
                <div class="recap-card">
                    <h3>Total Pendapatan</h3>
                    <div class="amount" id="recap-revenue">Rp 0</div>
                </div>
                <div class="recap-card expense">
                    <h3>Total HPP</h3>
                    <div class="amount" id="recap-cost-of-goods">Rp 0</div>
                </div>
                 <div class="recap-card expense">
                    <h3>Total Pengeluaran</h3>
                    <div class="amount" id="recap-total-expense">Rp 0</div>
                </div>
                <div class="recap-card profit">
                    <h3>Laba Bersih</h3>
                    <div class="amount" id="recap-profit">Rp 0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="color: var(--primary-dark-gold); margin-bottom: 20px;">Grafik Pendapatan</h3>
                <div class="form-group" style="width: 100%; max-width: 300px; text-align: center;">
                    <label for="chart-filter">Tampilan Grafik:</label>
                    <select id="chart-filter">
                        <option value="daily">Harian (30 Hari Terakhir)</option>
                        <option value="weekly">Mingguan (12 Minggu Terakhir)</option>
                        <option value="monthly">Bulanan (12 Bulan Terakhir)</option>
                        <option value="yearly">Tahunan</option>
                    </select>
                </div>
                <canvas id="incomeTrendChart" aria-label="Grafik Tren Pendapatan" role="img"></canvas>
                <p id="chart-empty-message" class="empty-chart-message" style="display:none;">Tidak ada data transaksi untuk menampilkan grafik.</p>
            </div>
            </div>

        <div id="pengaturan" class="tab-content">
            <h2><i data-feather="settings"></i> Pengaturan Aplikasi</h2>

            <div class="settings-section">
                <h3>Nama Perusahaan</h3>
                <div class="form-group">
                    <label for="company-name-input">Nama Perusahaan/Toko:</label>
                    <input type="text" id="company-name-input" placeholder="Masukkan nama perusahaan Anda">
                </div>
                <div class="button-group">
                    <button class="primary" id="save-company-name-btn"><i data-feather="save"></i> Simpan Nama Perusahaan</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Custom Logo Cetak Struk</h3>
                <p class="settings-info">Masukkan URL gambar logo Anda. Logo akan tampil di atas struk cetak.</p>
                <div class="form-group">
                    <label for="receipt-logo-url-input">URL Logo:</label>
                    <input type="text" id="receipt-logo-url-input" placeholder="Contoh: https://example.com/logo.png">
                </div>
                <div class="button-group">
                    <button class="primary" id="save-receipt-logo-btn"><i data-feather="image"></i> Simpan Logo</button>
                    <button class="secondary" id="clear-receipt-logo-btn"><i data-feather="x-circle"></i> Hapus Logo</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Manajemen Pengguna <span style="font-weight: normal; font-size: 0.8em; color: var(--info-color);">(Admin Only)</span></h3>
                <p class="settings-info">Tambahkan pengguna baru atau lihat daftar pengguna. Untuk keamanan, aplikasi ini hanya menyimpan data di browser Anda.</p>
                <div class="form-group">
                    <label for="new-user-username">Username:</label>
                    <input type="text" id="new-user-username" placeholder="Masukkan username baru">
                </div>
                <div class="form-group">
                    <label for="new-user-password">Password:</label>
                    <input type="password" id="new-user-password" placeholder="Masukkan password">
                </div>
                <div class="form-group">
                    <label for="new-user-role">Peran:</label>
                    <select id="new-user-role">
                        <option value="kasir">Kasir</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="success" id="add-new-user-btn"><i data-feather="user-plus"></i> Tambah Pengguna Baru</button>
                </div>

                <h4 style="margin-top: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-color);">Daftar Pengguna</h4>
                <div id="user-list-display">
                    <p class="empty-table-message">Tidak ada pengguna lain. Admin default selalu ada.</p>
                </div>
            </div>

            <div class="settings-section">
                <h3>Ekspor Data ke PDF</h3>
                <p class="settings-info">Unduh data produk, laporan penjualan, atau daftar pengeluaran Anda dalam format PDF.</p>
                <div class="button-group">
                    <button class="info" id="export-products-pdf-btn"><i data-feather="download"></i> Produk (PDF)</button>
                    <button class="info" id="export-transactions-pdf-btn"><i data-feather="download"></i> Laporan Penjualan (PDF)</button>
                    <button class="info" id="export-expenses-pdf-btn"><i data-feather="download"></i> Pengeluaran (PDF)</button>
                    <button class="info" id="export-recap-pdf-btn"><i data-feather="download"></i> Rekapan Keuangan (PDF)</button>
                     <button class="info" id="export-chart-pdf-btn"><i data-feather="download"></i> Grafik Pendapatan (PDF)</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Hapus Semua Data Aplikasi</h3>
                <p class="settings-info" style="color: var(--danger-color); font-weight: 600;">
                    PERINGATAN: Tindakan ini akan menghapus SEMUA data aplikasi (produk, keranjang, transaksi, pengeluaran, dan pengguna lain) yang tersimpan di browser Anda. Tindakan ini TIDAK DAPAT DIBATALKAN!
                </p>
                <div class="button-group">
                    <button class="danger" id="clear-all-data-btn"><i data-feather="alert-triangle"></i> Hapus Semua Data Aplikasi</button>
                </div>
            </div>
        </div>

    </main>

    <div id="notification-area">
    </div>

    <div id="loginModal" class="modal active">
        <div class="modal-content login-modal-content">
            <h3>Selamat Datang di <span id="login-company-name-display">Akuntansi Pintar</span></h3>
            <p class="company-name">Sistem Keuangan Anda</p>
            <div class="form-group">
                <label for="login-username">Username:</label>
                <input type="text" id="login-username" placeholder="Username Anda">
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" placeholder="Password Anda">
            </div>
            <div class="button-group">
                <button class="primary" id="login-btn"><i data-feather="log-in"></i> Login</button>
            </div>
            <p class="info-text">Default Admin: username `admin`, password `admin123`</p>
        </div>
    </div>


    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Edit Produk</h3>
            <div class="form-group">
                <label for="modal-product-id">ID Produk:</label>
                <input type="text" id="modal-product-id" readonly>
            </div>
            <div class="form-group">
                <label for="modal-product-name">Nama Produk:</label>
                <input type="text" id="modal-product-name">
            </div>
            <div class="form-group">
                <label for="modal-product-category">Kategori:</label>
                <input type="text" id="modal-product-category">
            </div>
            <div class="form-group">
                <label for="modal-product-cost-price">Harga Beli (Rp):</label>
                <input type="number" id="modal-product-cost-price" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-price">Harga Jual (Rp):</label>
                <input type="number" id="modal-product-price" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-markup-percentage">Markup (%):</label>
                <input type="number" id="modal-product-markup-percentage" min="0" max="1000" step="0.01" readonly title="Markup dihitung otomatis (Harga Jual - Harga Beli) / Harga Beli * 100">
            </div>
            <div class="form-group">
                <label for="modal-product-stock">Stok:</label>
                <input type="number" id="modal-product-stock" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-min-stock">Min. Stok untuk Peringatan:</label>
                <input type="number" id="modal-product-min-stock" min="0">
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-edit-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-product-btn"><i data-feather="save"></i> Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="stockAdjustmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3 id="stock-modal-title">Penyesuaian Stok</h3>
            <p>Produk: <strong id="stock-product-name-display"></strong> (ID: <span id="stock-product-id-display"></span>)</p>
            <p>Stok Saat Ini: <strong id="current-stock-display"></strong></p>
            <div class="form-group">
                <label for="stock-adjustment-type">Jenis Penyesuaian:</label>
                <select id="stock-adjustment-type">
                    <option value="in">Barang Masuk (Tambah Stok)</option>
                    <option value="out">Barang Keluar (Kurangi Stok)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stock-adjustment-quantity">Jumlah:</label>
                <input type="number" id="stock-adjustment-quantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="stock-adjustment-reason">Alasan (opsional):</label>
                <textarea id="stock-adjustment-reason" rows="2" placeholder="Contoh: Barang baru datang, Rusak, Retur"></textarea>
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-stock-adjustment-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-stock-adjustment-btn"><i data-feather="save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <div id="transactionDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Detail Transaksi</h3>
            <p><strong>ID Transaksi:</strong> <span id="detail-transaction-id"></span></p>
            <p><strong>Tanggal:</strong> <span id="detail-transaction-date"></span></p>
            <h4>Item:</h4>
            <ul id="detail-transaction-items"></ul>
            <div class="summary-row"><span>Subtotal:</span> <span id="detail-transaction-subtotal"></span></div>
            <div class="summary-row"><span>Diskon:</span> <span id="detail-transaction-discount">Rp 0</span></div>
            <div class="summary-row total"><span>Total:</span> <span id="detail-transaction-total"></span></div>
            <div class="summary-row"><span>Jumlah Dibayar:</span> <span id="detail-transaction-paid"></span></div>
            <div class="summary-row"><span>Kembalian:</span> <span id="detail-transaction-change"></span></div>
            <div class="button-group" style="justify-content: center;">
                <button class="info" id="close-detail-modal-btn"><i data-feather="x"></i> Tutup</button>
                <button class="primary" id="print-receipt-btn"><i data-feather="printer"></i> Cetak Struk</button>
            </div>
        </div>
    </div>

    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Edit Pengeluaran</h3>
            <div class="form-group">
                <label for="modal-expense-id">ID Pengeluaran:</label>
                <input type="text" id="modal-expense-id" readonly>
            </div>
            <div class="form-group">
                <label for="modal-expense-date">Tanggal:</label>
                <input type="date" id="modal-expense-date">
            </div>
            <div class="form-group">
                <label for="modal-expense-category">Kategori:</label>
                <input type="text" id="modal-expense-category">
            </div>
            <div class="form-group">
                <label for="modal-expense-description">Deskripsi:</label>
                <textarea id="modal-expense-description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="modal-expense-amount">Jumlah (Rp):</label>
                <input type="number" id="modal-expense-amount" min="0">
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-expense-edit-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-expense-btn"><i data-feather="save"></i> Simpan Perubahan</button>
            </div>
        </div>
    </div>


    <div id="printReceiptContent" class="print-receipt-content" style="display:none;">
        <div class="receipt-logo-container">
            <img id="receipt-logo" src="" alt="Company Logo" style="max-width: 100px; max-height: 80px; display: none;">
        </div>
    </div>

    <div id="aboutUsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3><i data-feather="info"></i> Tentang Akuntansi Pintar</h3>
            <p><strong>Akuntansi Pintar</strong> versi 1.0.0</p>
            <p>Aplikasi ini dirancang untuk membantu para UMKM dalam hal pencatatan data keuangan usaha.</p>
            <p><strong>Pengembang Utama:</strong> Bagus Fathur</p>
            <p style="margin-left: 20px;">
                Telp: 087800149808<br>
                Email: <a href="mailto:fathurb100@gmail.com">fathurb100@gmail.com</a><br>
                TikTok: <a href="https://www.tiktok.com/@arcofartur" target="_blank">@arcofartur</a><br>
                Instagram: <a href="https://www.instagram.com/fathur_rc" target="_blank">fathur_Rc</a>
            </p>
            <p><strong>Berkolaborasi dengan:</strong> AI Gemini</p>
            <p><strong>Pengkoreksi:</strong> Yuniar Rachmalita</p>
            <p style="margin-left: 20px;">
                Email: <a href="mailto:yuniarrachmalita711@gmail.com">yuniarrachmalita711@gmail.com</a><br>
                TikTok: <a href="https://www.tiktok.com/@its_niarlt" target="_blank">@its_niarlt</a><br>
                Instagram: <a href="https://www.instagram.com/niarchmlt._" target="_blank">niarchmlt._</a>
            </p>
            <p><strong>Toko Penguji Pertama:</strong> Sinar Photo Copy</p>
            <p style="margin-left: 20px;">
                WhatsApp: <a href="https://wa.me/6285232347655" target="_blank">+62 852-3234-7655</a>
            </p>
            <div class="button-group" style="margin-top: 30px;">
                <button class="info" id="close-about-us-modal-btn"><i data-feather="x"></i> Tutup</button>
            </div>
        </div>
    </div>


    <footer>
        <p>&copy; 2025 <span id="footer-company-name">Akuntansi Pintar</span>. <a href="#" id="about-us-link">Tentang Kami</a>. Hak cipta dilindungi.</p>
    </footer>

    <script>
        // Data Storage (using localStorage for simplicity)
        let products = JSON.parse(localStorage.getItem('products')) || [];
        let expenses = JSON.parse(localStorage.getItem('expenses')) || [];
        let transactions = JSON.parse(localStorage.getItem('transactions')) || [];
        let users = JSON.parse(localStorage.getItem('users')) || [{ username: 'admin', password: 'admin123', role: 'admin' }];
        let companyName = localStorage.getItem('companyName') || 'Akuntansi Pintar';
        let receiptLogoUrl = localStorage.getItem('receiptLogoUrl') || ''; // New: Store logo URL
        let currentUser = null; // To store logged-in user

        // Cart State
        let cart = [];
        let transactionIdCounter = parseInt(localStorage.getItem('transactionIdCounter')) || 1;
        let expenseIdCounter = parseInt(localStorage.getItem('expenseIdCounter')) || 1;
        let productIdCounter = parseInt(localStorage.getItem('productIdCounter')) || 101; // Start product IDs from 101

        // DOM Elements
        const loginModal = document.getElementById('loginModal');
        const loginUsernameInput = document.getElementById('login-username');
        const loginPasswordInput = document.getElementById('login-password');
        const loginBtn = document.getElementById('login-btn');
        const loginCompanyNameDisplay = document.getElementById('login-company-name-display');

        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const notificationArea = document.getElementById('notification-area');

        // Kasir Tab Elements
        const productSelect = document.getElementById('product-select');
        const categoryFilter = document.getElementById('category-filter');
        const productNameInput = document.getElementById('product-name');
        const productPriceInput = document.getElementById('product-price');
        const productStockDisplay = document.getElementById('product-stock-display');
        const productQuantityInput = document.getElementById('product-quantity');
        const addToCartBtn = document.getElementById('add-to-cart-btn');
        const clearInputBtn = document.getElementById('clear-input-btn');
        const cartItemsContainer = document.getElementById('cart-items');
        const subtotalSpan = document.getElementById('subtotal');
        const discountTypeSelect = document.getElementById('discount-type');
        const discountValueGroup = document.getElementById('discount-value-group');
        const discountValueInput = document.getElementById('discount-value');
        const discountSpan = document.getElementById('discount');
        const totalPaymentSpan = document.getElementById('total-payment');
        const amountPaidInput = document.getElementById('amount-paid');
        const changeAmountSpan = document.getElementById('change-amount');
        const changeRow = document.getElementById('change-row');
        const processPaymentBtn = document.getElementById('process-payment-btn');
        const clearCartBtn = document.getElementById('clear-cart-btn');

        // Produk Tab Elements
        const newProductNameInput = document.getElementById('new-product-name');
        const newProductCategoryInput = document.getElementById('new-product-category');
        const newProductCostPriceInput = document.getElementById('new-product-cost-price');
        const newProductPriceInput = document.getElementById('new-product-price');
        const newProductMarkupPercentageInput = document.getElementById('new-product-markup-percentage');
        const newProductStockInput = document.getElementById('new-product-stock');
        const newProductMinStockInput = document.getElementById('new-product-min-stock');
        const addNewProductBtn = document.getElementById('add-new-product-btn');
        const productListBody = document.getElementById('product-list-body');
        const productTable = document.getElementById('product-table');

        // Edit Product Modal Elements
        const editProductModal = document.getElementById('editProductModal');
        const modalProductId = document.getElementById('modal-product-id');
        const modalProductName = document.getElementById('modal-product-name');
        const modalProductCategory = document.getElementById('modal-product-category');
        const modalProductCostPrice = document.getElementById('modal-product-cost-price');
        const modalProductPrice = document.getElementById('modal-product-price');
        const modalProductMarkupPercentage = document.getElementById('modal-product-markup-percentage');
        const modalProductStock = document.getElementById('modal-product-stock');
        const modalProductMinStock = document.getElementById('modal-product-min-stock');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const saveProductBtn = document.getElementById('save-product-btn');

        // Stock Adjustment Modal Elements
        const stockAdjustmentModal = document.getElementById('stockAdjustmentModal');
        const stockModalTitle = document.getElementById('stock-modal-title');
        const stockProductNameDisplay = document.getElementById('stock-product-name-display');
        const stockProductIdDisplay = document.getElementById('stock-product-id-display');
        const currentStockDisplay = document.getElementById('current-stock-display');
        const stockAdjustmentType = document.getElementById('stock-adjustment-type');
        const stockAdjustmentQuantity = document.getElementById('stock-adjustment-quantity');
        const stockAdjustmentReason = document.getElementById('stock-adjustment-reason');
        const cancelStockAdjustmentBtn = document.getElementById('cancel-stock-adjustment-btn');
        const saveStockAdjustmentBtn = document.getElementById('save-stock-adjustment-btn');
        let currentProductForStockAdjustment = null;

        // Pengeluaran Tab Elements
        const expenseDateInput = document.getElementById('expense-date');
        const expenseCategoryInput = document.getElementById('expense-category');
        const expenseDescriptionInput = document.getElementById('expense-description');
        const expenseAmountInput = document.getElementById('expense-amount');
        const addExpenseBtn = document.getElementById('add-expense-btn');
        const expenseListBody = document.getElementById('expense-list-body');
        const expenseTable = document.getElementById('expense-table');

        // Edit Expense Modal Elements
        const editExpenseModal = document.getElementById('editExpenseModal');
        const modalExpenseId = document.getElementById('modal-expense-id');
        const modalExpenseDate = document.getElementById('modal-expense-date');
        const modalExpenseCategory = document.getElementById('modal-expense-category');
        const modalExpenseDescription = document.getElementById('modal-expense-description');
        const modalExpenseAmount = document.getElementById('modal-expense-amount');
        const cancelExpenseEditBtn = document.getElementById('cancel-expense-edit-btn');
        const saveExpenseBtn = document.getElementById('save-expense-btn');

        // Laporan Penjualan Tab Elements
        const reportDateFilter = document.getElementById('report-date-filter');
        const transactionListBody = document.getElementById('transaction-list-body');

        // Transaction Detail Modal Elements
        const transactionDetailModal = document.getElementById('transactionDetailModal');
        const detailTransactionId = document.getElementById('detail-transaction-id');
        const detailTransactionDate = document.getElementById('detail-transaction-date');
        const detailTransactionItems = document.getElementById('detail-transaction-items');
        const detailTransactionSubtotal = document.getElementById('detail-transaction-subtotal');
        const detailTransactionDiscount = document.getElementById('detail-transaction-discount');
        const detailTransactionTotal = document.getElementById('detail-transaction-total');
        const detailTransactionPaid = document.getElementById('detail-transaction-paid');
        const detailTransactionChange = document.getElementById('detail-transaction-change');
        const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
        const printReceiptBtn = document.getElementById('print-receipt-btn');
        const printReceiptContent = document.getElementById('printReceiptContent');
        const receiptLogo = document.getElementById('receipt-logo'); // New: Receipt logo element

        // Rekapan Keuangan Tab Elements
        const recapRevenueSpan = document.getElementById('recap-revenue');
        const recapCostOfGoodsSpan = document.getElementById('recap-cost-of-goods');
        const recapTotalExpenseSpan = document.getElementById('recap-total-expense');
        const recapProfitSpan = document.getElementById('recap-profit');
        const incomeTrendChartCanvas = document.getElementById('incomeTrendChart');
        const chartFilterSelect = document.getElementById('chart-filter');
        const chartEmptyMessage = document.getElementById('chart-empty-message');
        let incomeChart = null;

        // Pengaturan Tab Elements
        const companyNameInput = document.getElementById('company-name-input');
        const saveCompanyNameBtn = document.getElementById('save-company-name-btn');
        const receiptLogoUrlInput = document.getElementById('receipt-logo-url-input'); // New: Logo URL input
        const saveReceiptLogoBtn = document.getElementById('save-receipt-logo-btn'); // New: Save logo button
        const clearReceiptLogoBtn = document.getElementById('clear-receipt-logo-btn'); // New: Clear logo button
        const newUsernameInput = document.getElementById('new-user-username');
        const newPasswordInput = document.getElementById('new-user-password');
        const newUserRoleSelect = document.getElementById('new-user-role');
        const addNewUserBtn = document.getElementById('add-new-user-btn');
        const userListDisplay = document.getElementById('user-list-display');
        const exportProductsPdfBtn = document.getElementById('export-products-pdf-btn');
        const exportTransactionsPdfBtn = document.getElementById('export-transactions-pdf-btn');
        const exportExpensesPdfBtn = document.getElementById('export-expenses-pdf-btn');
        const exportRecapPdfBtn = document.getElementById('export-recap-pdf-btn');
        const exportChartPdfBtn = document.getElementById('export-chart-pdf-btn');
        const clearAllDataBtn = document.getElementById('clear-all-data-btn');

        const appCompanyNameHeader = document.getElementById('app-company-name');
        const footerCompanyName = document.getElementById('footer-company-name');
        const aboutUsLink = document.getElementById('about-us-link');
        const aboutUsModal = document.getElementById('aboutUsModal');
        const closeAboutUsModalBtn = document.getElementById('close-about-us-modal-btn');

        // --- Utility Functions ---
        function formatRupiah(number) {
            return new Intl.NumberFormat('id-ID', {
                style: 'currency',
                currency: 'IDR',
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(number);
        }

        function generateId(prefix, counter) {
            const date = new Date();
            const year = date.getFullYear().toString().slice(-2);
            const month = (date.getMonth() + 1).toString().padStart(2, '0');
            const day = date.getDate().toString().padStart(2, '0');
            return `${prefix}-${year}${month}${day}-${counter}`;
        }

        function showNotification(message, type = 'info', duration = 3000) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            notification.style.setProperty('--notification-duration', `${duration / 1000}s`);

            notificationArea.appendChild(notification);

            // Remove notification after animation
            setTimeout(() => {
                notification.remove();
            }, duration + 500); // .5s buffer for animation
        }

        function saveData() {
            localStorage.setItem('products', JSON.stringify(products));
            localStorage.setItem('expenses', JSON.stringify(expenses));
            localStorage.setItem('transactions', JSON.stringify(transactions));
            localStorage.setItem('users', JSON.stringify(users));
            localStorage.setItem('companyName', companyName);
            localStorage.setItem('receiptLogoUrl', receiptLogoUrl); // New: Save logo URL
            localStorage.setItem('transactionIdCounter', transactionIdCounter);
            localStorage.setItem('expenseIdCounter', expenseIdCounter);
            localStorage.setItem('productIdCounter', productIdCounter);
            updateUI();
        }

        function updateUI() {
            renderProductList();
            populateProductSelect();
            populateCategoryFilter();
            updateCartDisplay();
            updateRecapSummary();
            renderTransactionList();
            renderExpenseList();
            renderUserList();
            updateChart();
            updateCompanyNameDisplay();
            updateReceiptLogoDisplay(); // New: Update logo display
            feather.replace(); // Re-render feather icons
        }

        function updateCompanyNameDisplay() {
            appCompanyNameHeader.textContent = companyName;
            loginCompanyNameDisplay.textContent = companyName;
            footerCompanyName.textContent = companyName;
        }

        // New: Function to update receipt logo display
        function updateReceiptLogoDisplay() {
            if (receiptLogoUrl) {
                receiptLogo.src = receiptLogoUrl;
                receiptLogo.style.display = 'block';
            } else {
                receiptLogo.src = '';
                receiptLogo.style.display = 'none';
            }
        }

        function clearKasirInputs() {
            productSelect.value = '';
            productNameInput.value = '';
            productPriceInput.value = '';
            productStockDisplay.value = '';
            productQuantityInput.value = '1';
            categoryFilter.value = ''; // Reset category filter
            populateProductSelect(); // Repopulate to show all products
        }

        // --- Login Functionality ---
        function handleLogin() {
            const username = loginUsernameInput.value.trim();
            const password = loginPasswordInput.value.trim();

            const user = users.find(u => u.username === username && u.password === password);

            if (user) {
                currentUser = user;
                loginModal.classList.remove('active');
                loginModal.style.display = 'none'; // Ensure it's fully hidden
                showNotification(`Selamat datang, ${currentUser.username}!`, 'success');
                updateTabVisibility();
                // Manually trigger click on the active tab to load its content
                // Find the currently active tab button and click it after successful login
                const activeTabButton = document.querySelector('.tab-button.active');
                if (activeTabButton) {
                    activeTabButton.click();
                } else { // Fallback if no active tab, activate Kasir tab
                    document.querySelector('.tab-button[data-tab="kasir"]').click();
                }
            } else {
                showNotification('Username atau password salah.', 'error');
            }
        }

        function updateTabVisibility() {
            tabButtons.forEach(button => {
                const tabId = button.dataset.tab;
                if (currentUser.role === 'kasir' && (tabId === 'produk' || tabId === 'pengeluaran' || tabId === 'rekapan' || tabId === 'pengaturan')) {
                    button.style.display = 'none';
                } else {
                    button.style.display = '';
                }
            });
            // Ensure Kasir tab is active if current tab is hidden for Kasir
            const activeTab = document.querySelector('.tab-button.active');
            if (activeTab && activeTab.style.display === 'none') {
                document.querySelector('.tab-button[data-tab="kasir"]').click();
            }
        }


        // --- Tab Navigation ---
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                tabButtons.forEach(btn => btn.classList.remove('active'));
                tabContents.forEach(content => content.classList.remove('active'));

                button.classList.add('active');
                document.getElementById(button.dataset.tab).classList.add('active');

                // Specific actions for each tab when activated
                if (button.dataset.tab === 'produk') {
                    renderProductList();
                } else if (button.dataset.tab === 'pengeluaran') {
                    renderExpenseList();
                    expenseDateInput.valueAsDate = new Date(); // Set default date
                } else if (button.dataset.tab === 'laporan') {
                    const today = new Date();
                    const month = (today.getMonth() + 1).toString().padStart(2, '0');
                    const year = today.getFullYear();
                    reportDateFilter.value = `${year}-${month}`;
                    renderTransactionList();
                } else if (button.dataset.tab === 'rekapan') {
                    updateRecapSummary();
                    updateChart();
                } else if (button.dataset.tab === 'pengaturan') {
                    companyNameInput.value = companyName;
                    receiptLogoUrlInput.value = receiptLogoUrl; // New: Populate logo URL input
                    renderUserList();
                }
                feather.replace(); // Re-render feather icons when switching tabs
            });
        });

        // --- Kasir Tab Logic ---
        function populateCategoryFilter() {
            const categories = [...new Set(products.map(p => p.category.toLowerCase()))];
            categoryFilter.innerHTML = '<option value="">-- Semua Kategori --</option>';
            categories.sort().forEach(category => {
                const option = document.createElement('option');
                option.value = category;
                option.textContent = category.charAt(0).toUpperCase() + category.slice(1);
                categoryFilter.appendChild(option);
            });
        }

        function populateProductSelect() {
            const selectedCategory = categoryFilter.value.toLowerCase();
            const filteredProducts = selectedCategory
                ? products.filter(p => p.category.toLowerCase() === selectedCategory)
                : products;

            productSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
            filteredProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.id;
                option.textContent = `${product.name} (Stok: ${product.stock})`;
                productSelect.appendChild(option);
            });
            // Do not clear inputs here, as it might erase selected product when category changes
            // clearKasirInputs(); // Moved to be called explicitly when needed
        }

        // Event listener for product selection change
        productSelect.addEventListener('change', (e) => {
            const selectedProductId = e.target.value;
            const selectedProduct = products.find(p => p.id === selectedProductId);

            if (selectedProduct) {
                productNameInput.value = selectedProduct.name;
                productPriceInput.value = selectedProduct.price;
                productStockDisplay.value = selectedProduct.stock;
                productQuantityInput.value = 1;
            } else {
                productNameInput.value = '';
                productPriceInput.value = '';
                productStockDisplay.value = '';
                productQuantityInput.value = 1;
            }
        });

        categoryFilter.addEventListener('change', populateProductSelect);

        addToCartBtn.addEventListener('click', () => {
            const productId = productSelect.value;
            const quantity = parseInt(productQuantityInput.value);

            if (!productId) {
                showNotification('Pilih produk terlebih dahulu.', 'warning');
                return;
            }
            if (isNaN(quantity) || quantity <= 0) {
                showNotification('Jumlah produk harus lebih dari 0.', 'warning');
                return;
            }

            const product = products.find(p => p.id === productId);
            if (!product) {
                showNotification('Produk tidak ditemukan.', 'error');
                return;
            }

            if (product.stock < quantity) {
                showNotification(`Stok ${product.name} tidak cukup. Sisa stok: ${product.stock}`, 'error');
                return;
            }

            const existingCartItemIndex = cart.findIndex(item => item.id === productId);

            if (existingCartItemIndex > -1) {
                // Update quantity if product already in cart
                const newQuantity = cart[existingCartItemIndex].quantity + quantity;
                if (product.stock < newQuantity) {
                    showNotification(`Total stok ${product.name} tidak cukup. Hanya bisa menambah ${product.stock - cart[existingCartItemIndex].quantity} lagi.`, 'error');
                    return;
                }
                cart[existingCartItemIndex].quantity = newQuantity;
            } else {
                // Add new item to cart
                cart.push({
                    id: product.id,
                    name: product.name,
                    price: product.price,
                    costPrice: product.costPrice, // Store cost price for profit calculation
                    quantity: quantity
                });
            }

            product.stock -= quantity; // Deduct from stock immediately

            showNotification(`${quantity}x ${product.name} ditambahkan ke keranjang.`, 'success');
            clearKasirInputs();
            updateCartDisplay();
            saveData();
        });

        clearInputBtn.addEventListener('click', clearKasirInputs);

        function updateCartDisplay() {
            cartItemsContainer.innerHTML = '';
            if (cart.length === 0) {
                cartItemsContainer.innerHTML = '<p class="empty-cart-message">Keranjang kosong. Pilih produk dari daftar.</p>';
            } else {
                cart.forEach(item => {
                    const cartItemDiv = document.createElement('div');
                    cartItemDiv.className = 'cart-item';
                    cartItemDiv.innerHTML = `
                        <div class="cart-item-info">
                            <div class="cart-item-name">${item.name}</div>
                            <div class="cart-item-quantity">${item.quantity} x ${formatRupiah(item.price)}</div>
                        </div>
                        <div class="cart-item-total-price">${formatRupiah(item.quantity * item.price)}</div>
                        <div class="cart-item-actions">
                            <button class="danger" data-product-id="${item.id}" data-action="remove"><i data-feather="trash-2"></i></button>
                        </div>
                    `;
                    cartItemsContainer.appendChild(cartItemDiv);
                });
            }
            calculateCartTotals();
            feather.replace();
        }

        cartItemsContainer.addEventListener('click', (e) => {
            if (e.target.closest('button')) {
                const button = e.target.closest('button');
                const productId = button.dataset.productId;
                const action = button.dataset.action;

                if (action === 'remove') {
                    const itemIndex = cart.findIndex(item => item.id === productId);
                    if (itemIndex > -1) {
                        const item = cart[itemIndex];
                        const product = products.find(p => p.id === item.id);
                        if (product) {
                            product.stock += item.quantity; // Return stock
                        }
                        cart.splice(itemIndex, 1);
                        showNotification(`${item.name} dihapus dari keranjang.`, 'info');
                        updateCartDisplay();
                        saveData();
                    }
                }
            }
        });

        function calculateCartTotals() {
            let currentSubtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
            subtotalSpan.textContent = formatRupiah(currentSubtotal);

            let discountAmount = 0;
            const discountType = discountTypeSelect.value;
            const discountValue = parseFloat(discountValueInput.value) || 0;

            if (discountType === 'percentage' && discountValue > 0) {
                discountAmount = currentSubtotal * (discountValue / 100);
            } else if (discountType === 'nominal' && discountValue > 0) {
                discountAmount = discountValue;
            }
            // Ensure discount doesn't exceed subtotal
            discountAmount = Math.min(discountAmount, currentSubtotal);

            discountSpan.textContent = formatRupiah(discountAmount);

            let currentTotal = currentSubtotal - discountAmount;
            totalPaymentSpan.textContent = formatRupiah(currentTotal);

            const amountPaid = parseFloat(amountPaidInput.value) || 0;
            let change = amountPaid - currentTotal;
            changeAmountSpan.textContent = formatRupiah(change);

            if (change < 0) {
                changeRow.classList.remove('change-positive');
                changeRow.classList.add('change-negative');
                changeAmountSpan.textContent = `Kurang: ${formatRupiah(Math.abs(change))}`;
            } else {
                changeRow.classList.remove('change-negative');
                changeRow.classList.add('change-positive');
            }

            processPaymentBtn.disabled = cart.length === 0 || amountPaid < currentTotal;
        }

        discountTypeSelect.addEventListener('change', () => {
            if (discountTypeSelect.value === 'none') {
                discountValueGroup.style.display = 'none';
                discountValueInput.value = 0;
            } else {
                discountValueGroup.style.display = 'block';
            }
            calculateCartTotals();
        });

        discountValueInput.addEventListener('input', calculateCartTotals);
        amountPaidInput.addEventListener('input', calculateCartTotals);

        processPaymentBtn.addEventListener('click', () => {
            if (cart.length === 0) {
                showNotification('Keranjang masih kosong.', 'warning');
                return;
            }

            const totalAmount = parseFloat(totalPaymentSpan.textContent.replace(/[^0-9,-]+/g, "").replace(",", "."));
            const amountPaid = parseFloat(amountPaidInput.value);

            if (amountPaid < totalAmount) {
                showNotification('Jumlah dibayar kurang dari total pembayaran!', 'error');
                return;
            }

            const transactionDetails = cart.map(item => ({
                id: item.id,
                name: item.name,
                quantity: item.quantity,
                price: item.price,
                costPrice: item.costPrice,
                total: item.quantity * item.price
            }));

            const newTransaction = {
                id: generateId('TRX', transactionIdCounter++),
                date: new Date().toISOString().split('T')[0],
                time: new Date().toLocaleTimeString('id-ID'),
                items: transactionDetails,
                subtotal: cart.reduce((sum, item) => sum + (item.quantity * item.price), 0),
                discountType: discountTypeSelect.value,
                discountValue: parseFloat(discountValueInput.value) || 0,
                discountAmount: parseFloat(discountSpan.textContent.replace(/[^0-9,-]+/g, "").replace(",", ".")),
                total: totalAmount,
                amountPaid: amountPaid,
                change: amountPaid - totalAmount
            };

            transactions.push(newTransaction);
            saveData();
            showNotification('Pembayaran berhasil diproses!', 'success');
            clearCart();
            updateRecapSummary();
            updateChart(); // Update chart after transaction
            renderTransactionList(); // Re-render transaction list
            clearKasirInputs();

            showTransactionDetailModal(newTransaction);
        });

        clearCartBtn.addEventListener('click', () => {
            if (confirm('Anda yakin ingin mengosongkan keranjang? Stok produk akan dikembalikan.')) {
                clearCart();
                showNotification('Keranjang telah dikosongkan.', 'info');
                saveData();
            }
        });

        function clearCart() {
            // Return stock to products
            cart.forEach(cartItem => {
                const product = products.find(p => p.id === cartItem.id);
                if (product) {
                    product.stock += cartItem.quantity;
                }
            });
            cart = [];
            discountTypeSelect.value = 'none';
            discountValueInput.value = '0';
            discountValueGroup.style.display = 'none';
            amountPaidInput.value = '0';
            updateCartDisplay();
            saveData();
        }

        // --- Produk Tab Logic ---
        newProductCostPriceInput.addEventListener('input', calculateMarkup);
        newProductPriceInput.addEventListener('input', calculateMarkup);
        modalProductCostPrice.addEventListener('input', calculateModalMarkup);
        modalProductPrice.addEventListener('input', calculateModalMarkup);

        function calculateMarkup() {
            const costPrice = parseFloat(newProductCostPriceInput.value);
            const sellPrice = parseFloat(newProductPriceInput.value);
            if (costPrice > 0 && sellPrice >= costPrice) {
                const markup = ((sellPrice - costPrice) / costPrice) * 100;
                newProductMarkupPercentageInput.value = markup.toFixed(2);
            } else {
                newProductMarkupPercentageInput.value = '0.00';
            }
        }

        function calculateModalMarkup() {
            const costPrice = parseFloat(modalProductCostPrice.value);
            const sellPrice = parseFloat(modalProductPrice.value);
            if (costPrice > 0 && sellPrice >= costPrice) {
                const markup = ((sellPrice - costPrice) / costPrice) * 100;
                modalProductMarkupPercentage.value = markup.toFixed(2);
            } else {
                modalProductMarkupPercentage.value = '0.00';
            }
        }

        addNewProductBtn.addEventListener('click', () => {
            const name = newProductNameInput.value.trim();
            const category = newProductCategoryInput.value.trim();
            const costPrice = parseFloat(newProductCostPriceInput.value);
            const price = parseFloat(newProductPriceInput.value);
            const stock = parseInt(newProductStockInput.value);
            const minStock = parseInt(newProductMinStockInput.value);

            if (!name || !category || isNaN(costPrice) || costPrice < 0 || isNaN(price) || price < 0 || isNaN(stock) || stock < 0 || isNaN(minStock) || minStock < 0) {
                showNotification('Harap isi semua kolom produk dengan benar.', 'warning');
                return;
            }
            if (price < costPrice) {
                showNotification('Harga jual tidak boleh lebih rendah dari harga beli.', 'error');
                return;
            }

            const productId = generateId('PRD', productIdCounter++);
            const newProduct = {
                id: productId,
                name: name,
                category: category,
                costPrice: costPrice,
                price: price,
                stock: stock,
                minStock: minStock
            };

            products.push(newProduct);
            saveData();
            showNotification(`Produk "${name}" berhasil ditambahkan!`, 'success');
            clearNewProductInputs();
        });

        function clearNewProductInputs() {
            newProductNameInput.value = '';
            newProductCategoryInput.value = '';
            newProductCostPriceInput.value = '0';
            newProductPriceInput.value = '0';
            newProductMarkupPercentageInput.value = '0.00';
            newProductStockInput.value = '0';
            newProductMinStockInput.value = '0';
        }

        function renderProductList() {
            productListBody.innerHTML = '';
            if (products.length === 0) {
                productListBody.innerHTML = '<tr><td colspan="9" class="empty-table-message">Belum ada produk yang tercatat.</td></tr>';
                return;
            }
            products.forEach(product => {
                const markupPercentage = product.costPrice > 0 ? (((product.price - product.costPrice) / product.costPrice) * 100).toFixed(2) : '0.00';
                const row = productListBody.insertRow();
                row.innerHTML = `
                    <td>${product.id}</td>
                    <td>${product.name}</td>
                    <td>${product.category}</td>
                    <td>${formatRupiah(product.costPrice)}</td>
                    <td>${formatRupiah(product.price)}</td>
                    <td>${markupPercentage}%</td>
                    <td>${product.stock}</td>
                    <td>${product.minStock}</td>
                    <td class="table-actions">
                        <button class="info" data-id="${product.id}" data-action="adjust-stock"><i data-feather="repeat"></i> Stok</button>
                        <button class="secondary" data-id="${product.id}" data-action="edit"><i data-feather="edit"></i> Edit</button>
                        <button class="danger" data-id="${product.id}" data-action="delete"><i data-feather="trash"></i> Hapus</button>
                    </td>
                `;
            });
            feather.replace();
        }

        productListBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const productId = button.dataset.id;
                const action = button.dataset.action;

                if (action === 'edit') {
                    openEditProductModal(productId);
                } else if (action === 'delete') {
                    deleteProduct(productId);
                } else if (action === 'adjust-stock') {
                    openStockAdjustmentModal(productId);
                }
            }
        });

        function openEditProductModal(productId) {
            const product = products.find(p => p.id === productId);
            if (product) {
                modalProductId.value = product.id;
                modalProductName.value = product.name;
                modalProductCategory.value = product.category;
                modalProductCostPrice.value = product.costPrice;
                modalProductPrice.value = product.price;
                modalProductStock.value = product.stock;
                modalProductMinStock.value = product.minStock;
                calculateModalMarkup(); // Recalculate markup for the modal
                editProductModal.classList.add('active');
            }
        }

        editProductModal.querySelector('.close-button').addEventListener('click', () => {
            editProductModal.classList.remove('active');
        });
        cancelEditBtn.addEventListener('click', () => {
            editProductModal.classList.remove('active');
        });

        saveProductBtn.addEventListener('click', () => {
            const id = modalProductId.value;
            const name = modalProductName.value.trim();
            const category = modalProductCategory.value.trim();
            const costPrice = parseFloat(modalProductCostPrice.value);
            const price = parseFloat(modalProductPrice.value);
            const stock = parseInt(modalProductStock.value);
            const minStock = parseInt(modalProductMinStock.value);

            if (!name || !category || isNaN(costPrice) || costPrice < 0 || isNaN(price) || price < 0 || isNaN(stock) || stock < 0 || isNaN(minStock) || minStock < 0) {
                showNotification('Harap isi semua kolom dengan benar.', 'warning');
                return;
            }
            if (price < costPrice) {
                showNotification('Harga jual tidak boleh lebih rendah dari harga beli.', 'error');
                return;
            }

            const productIndex = products.findIndex(p => p.id === id);
            if (productIndex > -1) {
                products[productIndex] = { ...products[productIndex], name, category, costPrice, price, stock, minStock };
                saveData();
                showNotification(`Produk "${name}" berhasil diperbarui.`, 'success');
                editProductModal.classList.remove('active');
            } else {
                showNotification('Produk tidak ditemukan.', 'error');
            }
        });

        function deleteProduct(productId) {
            if (confirm('Anda yakin ingin menghapus produk ini?')) {
                products = products.filter(p => p.id !== productId);
                saveData();
                showNotification('Produk berhasil dihapus.', 'info');
            }
        }

        // --- Stock Adjustment Modal Logic ---
        function openStockAdjustmentModal(productId) {
            currentProductForStockAdjustment = products.find(p => p.id === productId);
            if (currentProductForStockAdjustment) {
                stockProductNameDisplay.textContent = currentProductForStockAdjustment.name;
                stockProductIdDisplay.textContent = currentProductForStockAdjustment.id;
                currentStockDisplay.textContent = currentProductForStockAdjustment.stock;
                stockAdjustmentQuantity.value = 1;
                stockAdjustmentReason.value = '';
                stockAdjustmentType.value = 'in'; // Default to 'in'
                stockAdjustmentModal.classList.add('active');
            }
        }

        stockAdjustmentModal.querySelector('.close-button').addEventListener('click', () => {
            stockAdjustmentModal.classList.remove('active');
        });
        cancelStockAdjustmentBtn.addEventListener('click', () => {
            stockAdjustmentModal.classList.remove('active');
        });

        saveStockAdjustmentBtn.addEventListener('click', () => {
            if (!currentProductForStockAdjustment) return;

            const quantity = parseInt(stockAdjustmentQuantity.value);
            const type = stockAdjustmentType.value;
            const reason = stockAdjustmentReason.value.trim();

            if (isNaN(quantity) || quantity <= 0) {
                showNotification('Jumlah penyesuaian harus lebih dari 0.', 'warning');
                return;
            }

            const productIndex = products.findIndex(p => p.id === currentProductForStockAdjustment.id);
            if (productIndex === -1) {
                showNotification('Produk tidak ditemukan.', 'error');
                return;
            }

            if (type === 'in') {
                products[productIndex].stock += quantity;
                showNotification(`Stok ${currentProductForStockAdjustment.name} ditambahkan sebanyak ${quantity}.`, 'success');
            } else if (type === 'out') {
                if (products[productIndex].stock < quantity) {
                    showNotification(`Stok ${currentProductForStockAdjustment.name} tidak cukup untuk dikurangi sebanyak ${quantity}. Stok saat ini: ${products[productIndex].stock}`, 'error');
                    return;
                }
                products[productIndex].stock -= quantity;
                showNotification(`Stok ${currentProductForStockAdjustment.name} dikurangi sebanyak ${quantity}.`, 'warning');
            }

            saveData();
            stockAdjustmentModal.classList.remove('active');
            currentProductForStockAdjustment = null;
        });


        // --- Pengeluaran Tab Logic ---
        addExpenseBtn.addEventListener('click', () => {
            const date = expenseDateInput.value;
            const category = expenseCategoryInput.value.trim();
            const description = expenseDescriptionInput.value.trim();
            const amount = parseFloat(expenseAmountInput.value);

            if (!date || !category || isNaN(amount) || amount <= 0) {
                showNotification('Harap isi tanggal, kategori, dan jumlah pengeluaran dengan benar.', 'warning');
                return;
            }

            const newExpense = {
                id: generateId('EXP', expenseIdCounter++),
                date: date,
                category: category,
                description: description,
                amount: amount
            };

            expenses.push(newExpense);
            saveData();
            showNotification(`Pengeluaran "${category}" sejumlah ${formatRupiah(amount)} berhasil ditambahkan.`, 'success');
            clearExpenseInputs();
            updateRecapSummary(); // Update recap after adding expense
        });

        function clearExpenseInputs() {
            expenseDateInput.valueAsDate = new Date(); // Set to current date
            expenseCategoryInput.value = '';
            expenseDescriptionInput.value = '';
            expenseAmountInput.value = '0';
        }

        function renderExpenseList() {
            expenseListBody.innerHTML = '';
            if (expenses.length === 0) {
                expenseListBody.innerHTML = '<tr><td colspan="6" class="empty-table-message">Belum ada pengeluaran yang tercatat.</td></tr>';
                return;
            }
            expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                const row = expenseListBody.insertRow();
                row.innerHTML = `
                    <td>${expense.id}</td>
                    <td>${expense.date}</td>
                    <td>${expense.category}</td>
                    <td>${expense.description}</td>
                    <td>${formatRupiah(expense.amount)}</td>
                    <td class="table-actions">
                        <button class="secondary" data-id="${expense.id}" data-action="edit"><i data-feather="edit"></i> Edit</button>
                        <button class="danger" data-id="${expense.id}" data-action="delete"><i data-feather="trash"></i> Hapus</button>
                    </td>
                `;
            });
            feather.replace();
        }

        expenseListBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const expenseId = button.dataset.id;
                const action = button.dataset.action;

                if (action === 'edit') {
                    openEditExpenseModal(expenseId);
                } else if (action === 'delete') {
                    deleteExpense(expenseId);
                }
            }
        });

        function openEditExpenseModal(expenseId) {
            const expense = expenses.find(e => e.id === expenseId);
            if (expense) {
                modalExpenseId.value = expense.id;
                modalExpenseDate.value = expense.date;
                modalExpenseCategory.value = expense.category;
                modalExpenseDescription.value = expense.description;
                modalExpenseAmount.value = expense.amount;
                editExpenseModal.classList.add('active');
            }
        }

        editExpenseModal.querySelector('.close-button').addEventListener('click', () => {
            editExpenseModal.classList.remove('active');
        });
        cancelExpenseEditBtn.addEventListener('click', () => {
            editExpenseModal.classList.remove('active');
        });

        saveExpenseBtn.addEventListener('click', () => {
            const id = modalExpenseId.value;
            const date = modalExpenseDate.value;
            const category = modalExpenseCategory.value.trim();
            const description = modalExpenseDescription.value.trim();
            const amount = parseFloat(modalExpenseAmount.value);

            if (!date || !category || isNaN(amount) || amount <= 0) {
                showNotification('Harap isi semua kolom dengan benar.', 'warning');
                return;
            }

            const expenseIndex = expenses.findIndex(e => e.id === id);
            if (expenseIndex > -1) {
                expenses[expenseIndex] = { ...expenses[expenseIndex], date, category, description, amount };
                saveData();
                showNotification(`Pengeluaran ID ${id} berhasil diperbarui.`, 'success');
                editExpenseModal.classList.remove('active');
            } else {
                showNotification('Pengeluaran tidak ditemukan.', 'error');
            }
        });

        function deleteExpense(expenseId) {
            if (confirm('Anda yakin ingin menghapus pengeluaran ini?')) {
                expenses = expenses.filter(e => e.id !== expenseId);
                saveData();
                showNotification('Pengeluaran berhasil dihapus.', 'info');
            }
        }

        // --- Laporan Penjualan Tab Logic ---
        reportDateFilter.addEventListener('change', renderTransactionList);

        function renderTransactionList() {
            transactionListBody.innerHTML = '';
            const filterDate = reportDateFilter.value; // Format YYYY-MM

            const filteredTransactions = transactions.filter(t => {
                if (!filterDate) return true; // No filter, show all
                // Ensure transaction.date is in YYYY-MM-DD for comparison
                return t.date.startsWith(filterDate);
            });

            if (filteredTransactions.length === 0) {
                transactionListBody.innerHTML = '<tr><td colspan="5" class="empty-table-message">Tidak ada transaksi untuk periode ini.</td></tr>';
                return;
            }

            // Sort by date (latest first)
            filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(transaction => {
                const row = transactionListBody.insertRow();
                row.innerHTML = `
                    <td>${transaction.id}</td>
                    <td>${transaction.date}</td>
                    <td>${formatRupiah(transaction.total)}</td>
                    <td>${formatRupiah(transaction.discountAmount)}</td>
                    <td class="table-actions">
                        <button class="info" data-id="${transaction.id}" data-action="view-detail"><i data-feather="eye"></i> Detail</button>
                        <button class="danger" data-id="${transaction.id}" data-action="delete-transaction"><i data-feather="trash"></i> Hapus</button>
                    </td>
                `;
            });
            feather.replace();
        }

        transactionListBody.addEventListener('click', (e) => {
            const button = e.target.closest('button');
            if (button) {
                const transactionId = button.dataset.id;
                const action = button.dataset.action;

                if (action === 'view-detail') {
                    showTransactionDetailModal(transactions.find(t => t.id === transactionId));
                } else if (action === 'delete-transaction') {
                    deleteTransaction(transactionId);
                }
            }
        });

        function showTransactionDetailModal(transaction) {
            if (!transaction) return;

            detailTransactionId.textContent = transaction.id;
            detailTransactionDate.textContent = transaction.date;
            detailTransactionSubtotal.textContent = formatRupiah(transaction.subtotal);
            detailTransactionDiscount.textContent = formatRupiah(transaction.discountAmount);
            detailTransactionTotal.textContent = formatRupiah(transaction.total);
            detailTransactionPaid.textContent = formatRupiah(transaction.amountPaid);
            detailTransactionChange.textContent = formatRupiah(transaction.change);

            detailTransactionItems.innerHTML = '';
            transaction.items.forEach(item => {
                const li = document.createElement('li');
                li.textContent = `${item.name} (${item.quantity} x ${formatRupiah(item.price)}) = ${formatRupiah(item.total)}`;
                detailTransactionItems.appendChild(li);
            });

            transactionDetailModal.classList.add('active');
        }

        transactionDetailModal.querySelector('.close-button').addEventListener('click', () => {
            transactionDetailModal.classList.remove('active');
        });
        closeDetailModalBtn.addEventListener('click', () => {
            transactionDetailModal.classList.remove('active');
        });

        printReceiptBtn.addEventListener('click', () => {
            const transactionId = detailTransactionId.textContent;
            const transaction = transactions.find(t => t.id === transactionId);
            if (transaction) {
                generateReceiptContent(transaction);
                window.print();
            }
        });

        function generateReceiptContent(transaction) {
            let logoHtml = '';
            if (receiptLogoUrl) {
                logoHtml = `
                    <div class="receipt-logo-container">
                        <img id="receipt-logo-print" src="${receiptLogoUrl}" alt="Company Logo">
                    </div>
                `;
            }

            let receiptHtml = `
                ${logoHtml}
                <div class="header">
                    <h3>${companyName}</h3>
                    <p>Struk Penjualan</p>
                    <p>Tanggal: ${transaction.date} ${transaction.time}</p>
                    <p>ID Transaksi: ${transaction.id}</p>
                </div>
                <div class="separator"></div>
                <h4>Detail Item:</h4>
            `;
            transaction.items.forEach(item => {
                receiptHtml += `
                    <div class="item-row">
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty-price">${item.quantity} x ${formatRupiah(item.price)}</span>
                    </div>
                    <div class="item-row text-right">Total: ${formatRupiah(item.total)}</div>
                `;
            });

            receiptHtml += `
                <div class="separator"></div>
                <div class="summary-row"><span>Subtotal:</span> <span class="text-right">${formatRupiah(transaction.subtotal)}</span></div>
                <div class="summary-row"><span>Diskon:</span> <span class="text-right">${formatRupiah(transaction.discountAmount)}</span></div>
                <div class="separator"></div>
                <div class="summary-row total"><span>TOTAL:</span> <span class="text-right">${formatRupiah(transaction.total)}</span></div>
                <div class="summary-row"><span>Dibayar:</span> <span class="text-right">${formatRupiah(transaction.amountPaid)}</span></div>
                <div class="summary-row"><span>Kembalian:</span> <span class="text-right">${formatRupiah(transaction.change)}</span></div>
                <div class="separator"></div>
                <div class="footer">
                    <p>Terima Kasih Atas Kunjungan Anda!</p>
                </div>
            `;
            printReceiptContent.innerHTML = receiptHtml;

            // Ensure the logo within printReceiptContent is correctly rendered
            const printLogo = printReceiptContent.querySelector('#receipt-logo-print');
            if (printLogo) {
                printLogo.onload = () => {
                    // Optional: If you need to do something after the image loads for print
                };
                printLogo.onerror = () => {
                    // Handle image loading error for print
                    printLogo.style.display = 'none'; // Hide if image fails to load
                    console.error("Failed to load receipt logo for printing.");
                };
            }
        }

        function deleteTransaction(transactionId) {
            if (confirm('Anda yakin ingin menghapus transaksi ini? Stok produk yang terjual pada transaksi ini tidak akan dikembalikan secara otomatis. Pastikan Anda mengelola stok secara manual jika diperlukan.')) {
                transactions = transactions.filter(t => t.id !== transactionId);
                saveData();
                showNotification('Transaksi berhasil dihapus.', 'info');
                updateRecapSummary(); // Re-calculate recap
                updateChart(); // Re-render chart
            }
        }


        // --- Rekapan Keuangan Tab Logic ---
        function updateRecapSummary() {
            let totalRevenue = 0;
            let totalCostOfGoodsSold = 0; // HPP (Harga Pokok Penjualan)
            let totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);

            transactions.forEach(transaction => {
                totalRevenue += transaction.total;
                transaction.items.forEach(item => {
                    totalCostOfGoodsSold += item.quantity * item.costPrice;
                });
            });

            const netProfit = totalRevenue - totalCostOfGoodsSold - totalExpenses;

            recapRevenueSpan.textContent = formatRupiah(totalRevenue);
            recapCostOfGoodsSpan.textContent = formatRupiah(totalCostOfGoodsSold);
            recapTotalExpenseSpan.textContent = formatRupiah(totalExpenses);
            recapProfitSpan.textContent = formatRupiah(netProfit);

            if (netProfit < 0) {
                recapProfitSpan.parentElement.classList.remove('profit');
                recapProfitSpan.parentElement.classList.add('expense'); // Use expense styling for negative profit
            } else {
                recapProfitSpan.parentElement.classList.remove('expense');
                recapProfitSpan.parentElement.classList.add('profit');
            }
        }

        // Chart Logic
        chartFilterSelect.addEventListener('change', updateChart);

        function getDatesForChart(filter) {
            const now = new Date();
            let labels = [];

            switch (filter) {
                case 'daily':
                    // Last 30 days
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date(now);
                        d.setDate(now.getDate() - i);
                        labels.push(d.toISOString().split('T')[0]);
                    }
                    break;
                case 'weekly':
                    // Last 12 weeks
                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now);
                        d.setDate(now.getDate() - (i * 7)); // Go back by weeks
                        // Get the start of the week (e.g., Monday or Sunday)
                        const dayOfWeek = d.getDay(); // 0 for Sunday, 1 for Monday
                        const startOfWeek = new Date(d);
                        // Adjust to Monday for consistency (if Sunday, go back 6 days; otherwise, go back to previous Monday)
                        startOfWeek.setDate(d.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                        labels.push(`Minggu ${startOfWeek.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' })}`);
                    }
                    break;
                case 'monthly':
                    // Last 12 months
                    for (let i = 11; i >= 0; i--) {
                        const d = new Date(now);
                        d.setMonth(now.getMonth() - i);
                        labels.push(d.toLocaleDateString('id-ID', { year: 'numeric', month: 'short' }));
                    }
                    break;
                case 'yearly':
                    // Last 5 years (adjust as needed)
                    for (let i = 4; i >= 0; i--) {
                        const year = now.getFullYear() - i;
                        labels.push(year.toString());
                    }
                    break;
            }
            return labels;
        }

        function calculateChartData(labels, filter) {
            const data = Array(labels.length).fill(0);

            transactions.forEach(transaction => {
                const transactionDate = new Date(transaction.date);
                let labelIndex = -1;

                switch (filter) {
                    case 'daily':
                        const dateString = transaction.date;
                        labelIndex = labels.indexOf(dateString);
                        break;
                    case 'weekly':
                        const dayOfWeek = transactionDate.getDay();
                        const startOfWeek = new Date(transactionDate);
                        startOfWeek.setDate(transactionDate.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // Adjust to Monday
                        const weekLabel = `Minggu ${startOfWeek.toLocaleDateString('id-ID', { month: 'short', day: 'numeric' })}`;
                        labelIndex = labels.indexOf(weekLabel);
                        break;
                    case 'monthly':
                        const monthLabel = transactionDate.toLocaleDateString('id-ID', { year: 'numeric', month: 'short' });
                        labelIndex = labels.indexOf(monthLabel);
                        break;
                    case 'yearly':
                        const yearLabel = transactionDate.getFullYear().toString();
                        labelIndex = labels.indexOf(yearLabel);
                        break;
                }

                if (labelIndex !== -1) {
                    data[labelIndex] += transaction.total;
                }
            });
            return data;
        }

        function updateChart() {
            const filter = chartFilterSelect.value;
            const labels = getDatesForChart(filter);
            const data = calculateChartData(labels, filter);

            if (incomeChart) {
                incomeChart.destroy();
            }

            const hasData = data.some(val => val > 0);
            if (!hasData) {
                incomeTrendChartCanvas.style.display = 'none';
                chartEmptyMessage.style.display = 'block';
                return;
            } else {
                incomeTrendChartCanvas.style.display = 'block';
                chartEmptyMessage.style.display = 'none';
            }


            const ctx = incomeTrendChartCanvas.getContext('2d');
            incomeChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Pendapatan (Rp)',
                        data: data,
                        backgroundColor: 'rgba(184, 134, 11, 0.4)', // Primary gold with transparency
                        borderColor: 'var(--primary-gold)',
                        borderWidth: 2,
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: 'var(--accent-gold)',
                        pointBorderColor: '#fff',
                        pointHoverBackgroundColor: '#fff',
                        pointHoverBorderColor: 'var(--primary-dark-gold)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            labels: {
                                color: 'var(--text-color)',
                                font: {
                                    size: 14,
                                    family: 'Poppins'
                                }
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.dataset.label || '';
                                    if (label) {
                                        label += ': ';
                                    }
                                    if (context.parsed.y !== null) {
                                        label += formatRupiah(context.parsed.y);
                                    }
                                    return label;
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                color: 'var(--light-text-color)',
                                font: { family: 'Poppins' }
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value, index, values) {
                                    return formatRupiah(value);
                                },
                                color: 'var(--light-text-color)',
                                font: { family: 'Poppins' }
                            },
                            grid: {
                                color: 'var(--border-color)'
                            }
                        }
                    }
                }
            });
        }


        // --- Pengaturan Tab Logic ---
        saveCompanyNameBtn.addEventListener('click', () => {
            const newName = companyNameInput.value.trim();
            if (newName) {
                companyName = newName;
                saveData();
                showNotification('Nama perusahaan berhasil diperbarui!', 'success');
            } else {
                showNotification('Nama perusahaan tidak boleh kosong.', 'warning');
            }
        });

        // New: Save Receipt Logo functionality
        saveReceiptLogoBtn.addEventListener('click', () => {
            const url = receiptLogoUrlInput.value.trim();
            if (url) {
                // Basic URL validation
                try {
                    new URL(url); // Throws an error if not a valid URL
                    receiptLogoUrl = url;
                    saveData();
                    showNotification('URL Logo struk berhasil disimpan!', 'success');
                } catch (e) {
                    showNotification('URL yang dimasukkan tidak valid.', 'error');
                }
            } else {
                showNotification('URL logo tidak boleh kosong.', 'warning');
            }
        });

        // New: Clear Receipt Logo functionality
        clearReceiptLogoBtn.addEventListener('click', () => {
            receiptLogoUrl = '';
            receiptLogoUrlInput.value = '';
            saveData();
            showNotification('Logo struk berhasil dihapus!', 'info');
        });


        addNewUserBtn.addEventListener('click', () => {
            if (currentUser.role !== 'admin') {
                showNotification('Anda tidak memiliki izin untuk menambahkan pengguna.', 'error');
                return;
            }

            const username = newUsernameInput.value.trim();
            const password = newPasswordInput.value.trim();
            const role = newUserRoleSelect.value;

            if (!username || !password) {
                showNotification('Username dan password tidak boleh kosong.', 'warning');
                return;
            }
            if (users.some(u => u.username === username)) {
                showNotification('Username sudah ada, pilih username lain.', 'error');
                return;
            }

            users.push({ username, password, role });
            saveData();
            showNotification(`Pengguna "${username}" (${role}) berhasil ditambahkan.`, 'success');
            newUsernameInput.value = '';
            newPasswordInput.value = '';
            newUserRoleSelect.value = 'kasir';
        });

        function renderUserList() {
            userListDisplay.innerHTML = '';
            if (users.length <= 1 && users.some(u => u.username === 'admin')) { // Only default admin
                userListDisplay.innerHTML = '<p class="empty-table-message">Tidak ada pengguna lain. Admin default selalu ada.</p>';
                return;
            }
            const ul = document.createElement('ul');
            users.filter(u => u.username !== 'admin').forEach(user => { // Don't allow deleting default admin
                const li = document.createElement('li');
                li.innerHTML = `
                    ${user.username} (${user.role})
                    <button class="danger" style="margin-left: 15px; padding: 5px 10px; font-size: 0.8em; border-radius: 5px;" data-username="${user.username}" data-action="delete-user">Hapus</button>
                `;
                ul.appendChild(li);
            });
            userListDisplay.appendChild(ul);
            feather.replace();
        }

        userListDisplay.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-action="delete-user"]');
            if (button) {
                if (currentUser.role !== 'admin') {
                    showNotification('Anda tidak memiliki izin untuk menghapus pengguna.', 'error');
                    return;
                }
                const usernameToDelete = button.dataset.username;
                if (confirm(`Anda yakin ingin menghapus pengguna "${usernameToDelete}"?`)) {
                    users = users.filter(u => u.username !== usernameToDelete);
                    saveData();
                    showNotification(`Pengguna "${usernameToDelete}" berhasil dihapus.`, 'info');
                }
            }
        });

        // PDF Export Functions
        exportProductsPdfBtn.addEventListener('click', () => {
            const element = document.createElement('div');
            let content = `<h2>Daftar Produk ${companyName}</h2>`;
            if (products.length === 0) {
                content += '<p>Belum ada produk yang tercatat.</p>';
            } else {
                content += `
                    <style>
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 10px;}
                        th { background-color: #f2f2f2; }
                    </style>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Nama</th>
                                <th>Kategori</th>
                                <th>Harga Beli</th>
                                <th>Harga Jual</th>
                                <th>Markup (%)</th>
                                <th>Stok</th>
                                <th>Min. Stok</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                products.forEach(p => {
                    const markup = p.costPrice > 0 ? (((p.price - p.costPrice) / p.costPrice) * 100).toFixed(2) : '0.00';
                    content += `
                        <tr>
                            <td>${p.id}</td>
                            <td>${p.name}</td>
                            <td>${p.category}</td>
                            <td>${formatRupiah(p.costPrice)}</td>
                            <td>${formatRupiah(p.price)}</td>
                            <td>${markup}%</td>
                            <td>${p.stock}</td>
                            <td>${p.minStock}</td>
                        </tr>
                    `;
                });
                content += `</tbody></table>`;
            }
            element.innerHTML = content;
            html2pdf().from(element).save(`Daftar Produk ${companyName}.pdf`);
            showNotification('Mengekspor daftar produk ke PDF...', 'info');
        });

        exportTransactionsPdfBtn.addEventListener('click', () => {
            const element = document.createElement('div');
            const filterDate = reportDateFilter.value;
            let title = `Laporan Penjualan ${companyName}`;
            if (filterDate) {
                const [year, month] = filterDate.split('-');
                const monthName = new Date(year, month - 1, 1).toLocaleDateString('id-ID', { month: 'long', year: 'numeric' });
                title += ` Bulan ${monthName}`;
            }

            const filteredTransactions = transactions.filter(t => {
                if (!filterDate) return true;
                return t.date.startsWith(filterDate);
            });

            let content = `<h2>${title}</h2>`;
            if (filteredTransactions.length === 0) {
                content += '<p>Tidak ada transaksi untuk periode ini.</p>';
            } else {
                content += `
                    <style>
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 10px;}
                        th { background-color: #f2f2f2; }
                    </style>
                    <table>
                        <thead>
                            <tr>
                                <th>ID Transaksi</th>
                                <th>Tanggal</th>
                                <th>Item</th>
                                <th>Subtotal</th>
                                <th>Diskon</th>
                                <th>Total</th>
                                <th>Dibayar</th>
                                <th>Kembalian</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                filteredTransactions.forEach(t => {
                    const itemsList = t.items.map(item => `${item.name} (${item.quantity}x)`).join(', ');
                    content += `
                        <tr>
                            <td>${t.id}</td>
                            <td>${t.date}</td>
                            <td>${itemsList}</td>
                            <td>${formatRupiah(t.subtotal)}</td>
                            <td>${formatRupiah(t.discountAmount)}</td>
                            <td>${formatRupiah(t.total)}</td>
                            <td>${formatRupiah(t.amountPaid)}</td>
                            <td>${formatRupiah(t.change)}</td>
                        </tr>
                    `;
                });
                content += `</tbody></table>`;
            }
            element.innerHTML = content;
            html2pdf().from(element).save(`${title}.pdf`);
            showNotification('Mengekspor laporan penjualan ke PDF...', 'info');
        });

        exportExpensesPdfBtn.addEventListener('click', () => {
            const element = document.createElement('div');
            let content = `<h2>Daftar Pengeluaran ${companyName}</h2>`;
            if (expenses.length === 0) {
                content += '<p>Belum ada pengeluaran yang tercatat.</p>';
            } else {
                content += `
                    <style>
                        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
                        th, td { border: 1px solid #ccc; padding: 8px; text-align: left; font-size: 10px;}
                        th { background-color: #f2f2f2; }
                    </style>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>Tanggal</th>
                                <th>Kategori</th>
                                <th>Deskripsi</th>
                                <th>Jumlah (Rp)</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                expenses.forEach(e => {
                    content += `
                        <tr>
                            <td>${e.id}</td>
                            <td>${e.date}</td>
                            <td>${e.category}</td>
                            <td>${e.description}</td>
                            <td>${formatRupiah(e.amount)}</td>
                        </tr>
                    `;
                });
                content += `</tbody></table>`;
            }
            element.innerHTML = content;
            html2pdf().from(element).save(`Daftar Pengeluaran ${companyName}.pdf`);
            showNotification('Mengekspor daftar pengeluaran ke PDF...', 'info');
        });

        exportRecapPdfBtn.addEventListener('click', () => {
            const element = document.createElement('div');

            let totalRevenue = 0;
            let totalCostOfGoodsSold = 0;
            let totalExpenses = expenses.reduce((sum, expense) => sum + expense.amount, 0);

            transactions.forEach(transaction => {
                totalRevenue += transaction.total;
                transaction.items.forEach(item => {
                    totalCostOfGoodsSold += item.quantity * item.costPrice;
                });
            });

            const netProfit = totalRevenue - totalCostOfGoodsSold - totalExpenses;

            let content = `<h2>Rekapan Keuangan ${companyName}</h2>
                <style>
                    .recap-item { margin-bottom: 10px; font-size: 14px; }
                    .recap-item span:first-child { font-weight: bold; display: inline-block; width: 150px; }
                    .recap-profit { color: ${netProfit >= 0 ? 'green' : 'red'}; font-size: 18px; font-weight: bold;}
                </style>
                <div class="recap-item"><span>Total Pendapatan:</span> ${formatRupiah(totalRevenue)}</div>
                <div class="recap-item"><span>Total HPP:</span> ${formatRupiah(totalCostOfGoodsSold)}</div>
                <div class="recap-item"><span>Total Pengeluaran:</span> ${formatRupiah(totalExpenses)}</div>
                <div class="recap-item recap-profit"><span>Laba Bersih:</span> ${formatRupiah(netProfit)}</div>
            `;
            element.innerHTML = content;
            html2pdf().from(element).save(`Rekapan Keuangan ${companyName}.pdf`);
            showNotification('Mengekspor rekapan keuangan ke PDF...', 'info');
        });

        exportChartPdfBtn.addEventListener('click', () => {
            if (!incomeChart || chartEmptyMessage.style.display === 'block') {
                showNotification('Tidak ada data grafik untuk diekspor.', 'warning');
                return;
            }

            // Get image of the chart
            const chartImage = incomeTrendChartCanvas.toDataURL('image/png');

            const element = document.createElement('div');
            element.innerHTML = `
                <h2>Grafik Pendapatan ${companyName} (${chartFilterSelect.options[chartFilterSelect.selectedIndex].text})</h2>
                <img src="${chartImage}" style="max-width: 100%; height: auto; display: block; margin: 20px auto;">
            `;

            html2pdf().from(element).save(`Grafik Pendapatan ${companyName}.pdf`);
            showNotification('Mengekspor grafik pendapatan ke PDF...', 'info');
        });


        // Clear All Data
        clearAllDataBtn.addEventListener('click', () => {
            if (currentUser.role !== 'admin') {
                showNotification('Anda tidak memiliki izin untuk menghapus semua data.', 'error');
                return;
            }
            if (confirm('PERINGATAN: Tindakan ini akan menghapus SEMUA data aplikasi secara permanen! Anda yakin ingin melanjutkan?')) {
                localStorage.clear();
                products = [];
                expenses = [];
                transactions = [];
                users = [{ username: 'admin', password: 'admin123', role: 'admin' }];
                companyName = 'Akuntansi Pintar';
                receiptLogoUrl = ''; // New: Clear logo URL on full data clear
                cart = [];
                transactionIdCounter = 1;
                expenseIdCounter = 1;
                productIdCounter = 101;
                currentUser = null; // Force re-login
                showNotification('Semua data aplikasi telah dihapus. Harap login kembali.', 'success');
                loginModal.classList.add('active');
                updateUI(); // Refresh UI after clearing data
            }
        });

        // About Us Modal
        aboutUsLink.addEventListener('click', (e) => {
            e.preventDefault();
            aboutUsModal.classList.add('active');
        });

        aboutUsModal.querySelector('.close-button').addEventListener('click', () => {
            aboutUsModal.classList.remove('active');
        });

        closeAboutUsModalBtn.addEventListener('click', () => {
            aboutUsModal.classList.remove('active');
        });


        // --- Initial Load ---
        document.addEventListener('DOMContentLoaded', () => {
            feather.replace();
            updateCompanyNameDisplay();

            // Set current date for expense input
            expenseDateInput.valueAsDate = new Date();

            // Initial render of product list, cart, and recap
            updateUI();

            // Check for existing user, otherwise show login modal
            if (!currentUser) {
                loginModal.classList.add('active');
            } else {
                updateTabVisibility();
                // Manually click the active tab to ensure its content is loaded
                // This is important because updateTabVisibility might hide the currently active tab.
                const activeTabButton = document.querySelector('.tab-button.active');
                if (activeTabButton && activeTabButton.style.display !== 'none') {
                    activeTabButton.click();
                } else if (document.querySelector('.tab-button[data-tab="kasir"]').style.display !== 'none') {
                    // Fallback: If current active tab is hidden, try activating Kasir
                    document.querySelector('.tab-button[data-tab="kasir"]').click();
                } else {
                    // If Kasir is also hidden (e.g., if roles change), just ensure some content shows
                    tabContents.forEach(content => content.classList.remove('active'));
                    document.getElementById('kasir').classList.add('active'); // Default to kasir
                }
            }

            // Set initial month for report filter
            const today = new Date();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            const year = today.getFullYear();
            reportDateFilter.value = `${year}-${month}`;
        });

        // Login Event Listener
        loginBtn.addEventListener('click', handleLogin);
        loginPasswordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                handleLogin();
            }
        });
    </script>
</body>
</html>
