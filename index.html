<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Akuntansi Pintar</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://unpkg.com/feather-icons"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>

    <style>
        /* --- Variabel Warna Emas Modern & Professional --- */
        :root {
            --primary-gold: #B8860B; /* Dark Goldenrod */
            --primary-dark-gold: #8B6914; /* Darker Gold */
            --light-gold: #FFD700; /* Gold */
            --accent-gold: #FFC107; /* Amber Gold */
            --text-color: #4A4A4A; /* Dark Gray for text */
            --light-text-color: #8C8C8C; /* Lighter Gray for subtle text */
            --light-bg: #F8F8F8; /* Very light gray for backgrounds */
            --dark-bg: #EAEAEA; /* Slightly darker gray for subtle accents */
            --card-bg: #FFFFFF; /* White for cards */
            --border-color: #D3D3D3; /* Light gray for borders */
            --danger-color: #E74C3C; /* Red */
            --success-color: #27AE60; /* Green */
            --info-color: #3498DB; /* Blue */
            --warning-color: #F1C40F; /* Yellow */
            --shadow-light: rgba(0, 0, 0, 0.08);
            --shadow-medium: rgba(0, 0, 0, 0.15);
            --shadow-dark: rgba(0, 0, 0, 0.25);

            /* Gradients (Updated for Gold) */
            --header-gradient: linear-gradient(135deg, var(--primary-gold) 0%, var(--primary-dark-gold) 100%);
            --button-primary-gradient: linear-gradient(45deg, var(--light-gold), var(--primary-gold));
            --button-success-gradient: linear-gradient(45deg, var(--success-color), #208b4e);
            --button-danger-gradient: linear-gradient(45deg, var(--danger-color), #c0392b);
            --button-secondary-gradient: linear-gradient(45deg, var(--accent-gold), #e0a300); /* Adjusted secondary */
        }

        /* --- Reset & Base Styles --- */
        * {
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            margin: 0;
            padding: 0;
            background-color: var(--light-bg);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            overflow-x: hidden;
            line-height: 1.6;
        }

        /* --- Header --- */
        header {
            background: var(--header-gradient);
            color: white;
            padding: 40px 0;
            text-align: center;
            box-shadow: 0 8px 16px var(--shadow-dark);
            position: relative;
            overflow: hidden;
        }
        header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('data:image/svg+xml;utf8,<svg width="60" height="60" viewBox="0 0 60 60" xmlns="http://www.w3.org/2000/svg"><g fill="%23ffffff" fill-opacity="0.05" fill-rule="evenodd"><path d="M0 60V0h60v60zM30 0L0 30l30 30L60 30z" fill-rule="nonzero"/></g></svg>');
            opacity: 0.2;
            pointer-events: none;
            z-index: 1;
        }

        header h1 {
            margin: 0;
            font-family: 'Montserrat', sans-serif;
            font-size: 4.5em; /* Diperbesar */
            font-weight: 800;
            letter-spacing: 0.12em; /* Diperjelas */
            /* Updated for shiny gold gradient */
            background: linear-gradient(
                45deg,
                #FFD700 0%,     /* Bright Gold */
                #DAA520 25%,    /* Goldenrod */
                #B8860B 50%,    /* Dark Goldenrod */
                #DAA520 75%,    /* Goldenrod */
                #FFD700 100%    /* Bright Gold */
            );
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            color: transparent; /* Fallback for browsers that don't support -webkit-text-fill-color */
            text-shadow: 2px 2px 5px var(--shadow-dark);
            position: relative;
            z-index: 2;
        }

        .app-creator { /* This class is now unused in HTML but kept in CSS for completeness */
            font-size: 1em;
            font-weight: 400;
            margin-top: 10px;
            opacity: 0.8;
            position: relative;
            z-index: 2;
        }

        /* --- Main Container --- */
        .container {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 30px;
            max-width: 1400px;
            margin: 30px auto;
            background-color: var(--card-bg);
            border-radius: 16px;
            box-shadow: 0 10px 30px var(--shadow-medium);
        }

        /* --- Tab Navigation --- */
        .tab-navigation {
            display: flex;
            border-bottom: 3px solid var(--border-color);
            margin-bottom: 30px;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            -ms-overflow-style: none;
            background-color: var(--dark-bg);
            border-radius: 8px;
            padding: 5px;
        }
        .tab-navigation::-webkit-scrollbar { display: none; }

        .tab-button {
            background-color: transparent;
            border: none;
            padding: 18px 30px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            color: var(--light-text-color);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            flex-shrink: 0;
            position: relative;
            overflow: hidden;
            border-radius: 6px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .tab-button:hover {
            color: var(--primary-gold);
            background-color: rgba(184, 134, 11, 0.08); /* RGB of primary-gold */
        }

        .tab-button.active {
            color: var(--text-color); /* Changed to dark text for gold background */
            background: var(--button-primary-gradient);
            box-shadow: 0 4px 10px var(--shadow-light);
            transform: translateY(-2px);
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background-color: var(--accent-gold);
        }

        /* --- Tab Content --- */
        .tab-content {
            display: none;
            padding: 20px 0;
            flex-direction: column;
            flex: 1;
            animation: fadeIn 0.5s ease-out;
        }
        .tab-content.active { display: flex; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Section Titles (H2) --- */
        h2 {
            color: var(--primary-dark-gold); /* Darker gold for headers */
            margin-top: 0;
            margin-bottom: 30px;
            font-size: 2.2em;
            font-weight: 700;
            border-bottom: 4px solid var(--border-color);
            padding-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        h2 svg {
            color: var(--accent-gold);
            font-size: 1.3em;
        }

        /* --- Kasir Layout --- */
        .kasir-layout {
            display: grid;
            grid-template-columns: 2fr 3fr;
            gap: 35px;
            flex: 1;
        }

        .left-panel, .right-panel {
            padding: 30px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--light-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
            display: flex;
            flex-direction: column;
        }

        /* --- Form Elements --- */
        .form-group {
            margin-bottom: 22px;
        }

        label {
            display: block;
            margin-bottom: 10px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 1em;
        }

        input[type="text"],
        input[type="number"],
        input[type="password"], /* Added for user management */
        input[type="date"], /* For expense and potentially other date inputs */
        select,
        textarea {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 1.05em;
            box-sizing: border-box;
            background-color: var(--card-bg);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
        }
        input[type="text"]:focus,
        input[type="number"]:focus,
        input[type="password"]:focus,
        input[type="date"]:focus,
        select:focus,
        textarea:focus {
            border-color: var(--primary-gold); /* Gold focus */
            box-shadow: 0 0 0 4px rgba(184, 134, 11, 0.25); /* Gold focus ring */
            outline: none;
        }
        input[readonly] {
            background-color: var(--dark-bg);
            cursor: not-allowed;
            opacity: 0.8;
        }
        textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* --- Button Group --- */
        .button-group {
            display: flex;
            gap: 18px;
            margin-top: 25px;
            flex-wrap: wrap;
            justify-content: flex-start;
        }
        .modal .button-group, .transaction-detail .button-group {
            justify-content: center;
        }
        .login-modal-content .button-group {
            justify-content: center;
            margin-top: 30px;
        }

        button {
            padding: 14px 25px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.05em;
            font-weight: 600;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            white-space: nowrap;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            box-shadow: 0 4px 8px var(--shadow-light);
            color: white; /* Default to white text for most buttons */
        }

        button.primary { background: var(--button-primary-gradient); color: var(--text-color); } /* Dark text on gold */
        button.primary:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.secondary { background: var(--button-secondary-gradient); color: var(--text-color); } /* Dark text on amber gold */
        button.secondary:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.danger { background: var(--button-danger-gradient); }
        button.danger:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.success { background: var(--button-success-gradient); }
        button.success:hover { transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.info { background-color: var(--info-color); }
        button.info:hover { background-color: #217dbb; transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        button.warning { background-color: var(--warning-color); color: var(--text-color); } /* Dark text on yellow */
        button.warning:hover { background-color: #d8af11; transform: translateY(-3px); box-shadow: 0 6px 12px var(--shadow-medium); }

        /* --- Cart Items Display --- */
        .cart-items {
            flex: 1;
            margin-bottom: 30px;
            overflow-y: auto; /* Agar bisa digeser vertikal secara default */
            max-height: 400px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background-color: var(--card-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .cart-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid var(--dark-bg);
            transition: background-color 0.2s ease;
        }
        .cart-item:last-child { border-bottom: none; }
        .cart-item:hover { background-color: var(--dark-bg); }

        .cart-item-info { flex-grow: 1; margin-right: 20px; }
        .cart-item-name { font-weight: 700; color: var(--primary-gold); font-size: 1.1em; } /* Gold product name */
        .cart-item-quantity, .cart-item-price-per-item { font-size: 0.9em; color: var(--light-text-color); }
        .cart-item-total-price { font-weight: 700; color: var(--success-color); white-space: nowrap; font-size: 1.2em; }
        .cart-item-actions button {
            padding: 8px 12px;
            font-size: 0.85em;
            border-radius: 6px;
            box-shadow: none;
            transform: none;
        }
        .cart-item-actions button:hover { opacity: 0.8; }
        .empty-cart-message, .empty-table-message, .empty-chart-message {
            text-align: center;
            color: var(--light-text-color);
            padding: 40px;
            font-style: italic;
            font-size: 1.1em;
        }

        /* --- Cart Summary --- */
        .cart-summary {
            margin-top: auto;
            border-top: 3px solid var(--primary-gold); /* Gold border top */
            padding-top: 25px;
        }

        .summary-row {
            display: flex;
            justify-content: space-between;
            margin-bottom: 15px;
            font-size: 1.15em;
            color: var(--text-color);
            font-weight: 500;
        }
        .summary-row.total {
            font-weight: 700;
            font-size: 1.8em;
            color: var(--primary-dark-gold); /* Darker gold for total */
            padding-top: 15px;
            border-top: 1px dashed var(--border-color);
            margin-top: 20px;
        }
        .summary-row.change-negative { color: var(--danger-color); }
        .summary-row.change-positive { color: var(--success-color); }


        /* --- Table Styles --- */
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 30px;
            background-color: var(--card-bg);
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px var(--shadow-light);
        }

        table thead th {
            background: var(--header-gradient);
            color: white;
            padding: 16px 20px;
            text-align: left;
            border-bottom: 2px solid var(--primary-dark-gold); /* Darker gold border */
            font-weight: 600;
            font-size: 1em;
        }

        table tbody td {
            padding: 14px 20px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-color);
            font-size: 0.95em;
        }

        table tbody tr:nth-child(even) { background-color: var(--light-bg); }
        table tbody tr:hover { background-color: var(--dark-bg); transition: background-color 0.2s ease; }

        .table-actions { display: flex; gap: 10px; }
        .table-actions button {
            padding: 9px 15px;
            font-size: 0.85em;
            box-shadow: none;
            transform: none;
        }
        .table-actions button:hover { opacity: 0.8; }

        /* --- Notification Area --- */
        #notification-area {
            position: fixed;
            top: 30px;
            right: 30px;
            z-index: 1000;
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-width: 350px;
        }

        .notification {
            background-color: #333;
            color: white;
            padding: 16px 25px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-dark);
            opacity: 0;
            transform: translateX(100%);
            animation: slideIn 0.5s forwards, fadeOut var(--notification-duration) forwards;
            animation-delay: 0s, calc(var(--notification-duration) - 0.5s);
            position: relative;
            overflow: hidden;
            font-weight: 500;
        }
        .notification::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 5px;
            background-color: rgba(255, 255, 255, 0.4);
            animation: progressBar var(--notification-duration) linear forwards;
        }
        @keyframes progressBar { from { width: 100%; } to { width: 0%; } }
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(100%); }
            to { opacity: 1; transform: translateX(0); }
        }
        @keyframes fadeOut {
            0% { opacity: 1; }
            80% { opacity: 1; }
            100% { opacity: 0; }
        }

        .notification.success { background-color: var(--success-color); }
        .notification.error   { background-color: var(--danger-color); }
        .notification.info    { background-color: var(--info-color); }
        .notification.warning { background-color: var(--warning-color); color: var(--text-color); }

        /* --- Footer --- */
        footer {
            background-color: var(--text-color);
            color: white;
            text-align: center;
            padding: 25px 0;
            margin-top: 50px;
            font-size: 0.95em;
            box-shadow: 0 -5px 15px var(--shadow-medium);
            flex-shrink: 0;
        }
        footer a {
            color: var(--light-gold); /* Warna emas untuk link di footer */
            text-decoration: none;
            transition: color 0.2s ease;
        }
        footer a:hover {
            color: var(--accent-gold);
            text-decoration: underline;
        }


        /* --- Modal Styles --- */
        .modal {
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .modal.active { opacity: 1; visibility: visible; }

        .modal-content {
            background-color: var(--card-bg);
            padding: 40px;
            border-radius: 16px;
            width: 95%;
            max-width: 600px;
            box-shadow: 0 15px 40px var(--shadow-dark);
            position: relative;
            transform: translateY(-30px);
            opacity: 0;
            transition: transform 0.3s ease, opacity 0.3s ease;
        }
        .modal.active .modal-content { transform: translateY(0); opacity: 1; }

        .close-button {
            color: var(--light-text-color);
            font-size: 35px;
            font-weight: bold;
            position: absolute;
            top: 20px;
            right: 25px;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .close-button:hover { color: var(--danger-color); }

        .modal-content h3 {
            color: var(--primary-gold); /* Gold modal header */
            margin-top: 0;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 15px;
            font-size: 2em;
        }
        .modal-content ul {
            list-style: none;
            padding: 0;
            margin-top: 15px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            max-height: 200px;
            overflow-y: auto;
            background-color: var(--light-bg);
        }
        .modal-content ul li {
            padding: 10px 15px;
            border-bottom: 1px dashed var(--dark-bg);
            font-size: 0.95em;
            color: var(--text-color);
        }
        .modal-content ul li:last-child { border-bottom: none; }

        .modal-content .summary-row {
            font-size: 1.1em;
            margin-bottom: 10px;
        }
        .modal-content .summary-row.total {
            font-size: 1.4em;
        }

        /* --- Rekapan Section Styles --- */
        .recap-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); /* Adjusted for more cards */
            gap: 30px;
            margin-top: 30px;
            padding: 25px;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            background-color: var(--light-bg);
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .recap-card {
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-light);
            text-align: center;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }
        .recap-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px var(--shadow-medium);
        }

        .recap-card h3 {
            color: var(--light-text-color);
            font-size: 1.4em;
            font-weight: 600;
            margin-top: 0;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 12px;
            text-align: center;
        }

        .recap-card .amount {
            font-size: 3.2em;
            font-family: 'Montserrat', sans-serif;
            font-weight: 800;
            color: var(--primary-gold); /* Gold amount */
            margin-bottom: 0;
            line-height: 1.2;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }

        .recap-card.expense .amount { color: var(--danger-color); }
        .recap-card.profit .amount { color: var(--success-color); }

        .chart-container {
            margin-top: 40px;
            background-color: var(--card-bg);
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 6px 15px var(--shadow-light);
            max-width: 100%;
            height: 400px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .chart-container canvas {
            max-width: 100% !important;
            max-height: 100% !important;
        }
        .chart-message {
            text-align: center;
            color: var(--light-text-color);
            padding: 20px;
            font-style: italic;
        }

        /* Pengaturan tab specific styles */
        .settings-section {
            background-color: var(--light-bg);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border-color);
            margin-bottom: 30px;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.03);
        }
        .settings-section h3 {
            color: var(--primary-dark-gold);
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 10px;
            margin-top: 0;
            margin-bottom: 20px;
        }
        .settings-info {
            font-size: 0.95em;
            color: var(--light-text-color);
            margin-top: -15px;
            margin-bottom: 20px;
        }
        .settings-section .button-group {
            margin-top: 20px;
            justify-content: flex-start;
        }

        /* Login Modal specific styles */
        .login-modal-content {
            max-width: 450px;
            text-align: center;
        }
        .login-modal-content h3 {
            font-size: 2.5em;
            color: var(--primary-dark-gold);
            border-bottom: none;
            margin-bottom: 10px;
        }
        .login-modal-content .company-name {
            font-size: 1.1em;
            color: var(--light-text-color);
            margin-bottom: 30px;
        }
        .login-modal-content .form-group {
            text-align: left;
        }
        .login-modal-content label {
            font-size: 1em;
        }
        .login-modal-content input {
            padding: 16px 20px;
            font-size: 1.1em;
            border-radius: 10px;
        }
        .login-modal-content button {
            width: 100%;
            padding: 16px;
            font-size: 1.2em;
        }
        .login-modal-content .info-text {
            font-size: 0.9em;
            color: var(--light-text-color);
            margin-top: 25px;
        }


        /* Print Receipt Style */
        @media print {
            body { background-color: white; margin: 0; padding: 0; color: #000; }
            header, footer, .container, .tab-navigation, #notification-area, .modal, button, .button-group, .settings-section { display: none !important; }
            .print-receipt-content {
                display: block !important;
                font-family: 'Consolas', 'Monospace', monospace;
                font-size: 12px;
                line-height: 1.4;
                width: 300px;
                margin: 0 auto;
                padding: 10px;
                box-sizing: border-box;
            }
            .print-receipt-content .header, .print-receipt-content .footer { text-align: center; margin-bottom: 10px; }
            .print-receipt-content .separator { border-top: 1px dashed #000; margin: 8px 0; }
            .print-receipt-content .item-row { display: flex; justify-content: space-between; margin-bottom: 3px; }
            .print-receipt-content .item-name { flex-grow: 1; padding-right: 5px; }
            .print-receipt-content .item-qty-price { white-space: nowrap; text-align: right; }
            .print-receipt-content .summary-row { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 5px; }
            .print-receipt-content .total-row { font-size: 1.1em; border-top: 1px dashed #000; padding-top: 5px; margin-top: 5px; }
            .print-receipt-content .text-right { text-align: right; }
            /* Logo specific styles for print */
            .print-receipt-content .receipt-logo-container { text-align: center; margin-bottom: 10px; }
            .print-receipt-content #receipt-logo-print { display: block; max-width: 100px; max-height: 80px; margin: 0 auto; }
        }

        /* --- Media Queries (Responsive Design) --- */
        @media (max-width: 1024px) {
            .kasir-layout { grid-template-columns: 1fr; }
            .left-panel, .right-panel { margin-bottom: 25px; }
            .tab-button { padding: 15px 25px; font-size: 1em; }
            header h1 { font-size: 3.8em; } /* Penyesuaian responsif */
            h2 { font-size: 2em; }
            .recap-summary { grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
            .recap-card .amount { font-size: 2.8em; }
        }

        @media (max-width: 768px) {
            .container { margin: 20px; padding: 20px; }
            header h1 { font-size: 3em; } /* Penyesuaian responsif */
            .app-creator { font-size: 0.9em; }
            h2 { font-size: 1.8em; margin-bottom: 25px; }
            .tab-navigation { flex-wrap: wrap; justify-content: center; padding: 3px; }
            .tab-button { flex-basis: 49%; margin: 2px; padding: 12px 20px; font-size: 0.95em; }
            input[type="text"], input[type="number"], select, textarea { padding: 12px 15px; font-size: 0.95em; }
            button { padding: 12px 20px; font-size: 0.95em; }
            .button-group { gap: 12px; margin-top: 20px; }
            .recap-summary { grid-template-columns: 1fr; }
            .recap-card .amount { font-size: 2.5em; }
            .recap-card h3 { font-size: 1.2em; }
            .cart-item { flex-wrap: wrap; gap: 8px; padding: 12px 15px; }
            .cart-item-name { flex-basis: 100%; }
            .cart-item-info, .cart-item-total-price, .cart-item-actions { flex-grow: 1; flex-basis: auto; }
            .cart-item-actions { justify-content: flex-end; }
            .summary-row { font-size: 1em; }
            .summary-row.total { font-size: 1.5em; }
            .modal-content { padding: 30px; }
            .modal-content h3 { font-size: 1.6em; }
        }

        @media (max-width: 480px) {
            header h1 { font-size: 2.5em; } /* Penyesuaian responsif */
            .container { margin: 10px; padding: 15px; }
            h2 { font-size: 1.6em; }
            .tab-button { flex-basis: 100%; }
            .notification { max-width: 90%; right: 5%; left: 5%; }
            .recap-card .amount { font-size: 2em; }
            .recap-card h3 { font-size: 1.2em; }
        }
        .scrollable-container {
          overflow: auto; /* Memungkinkan scroll baik vertikal maupun horizontal */
          cursor: grab;
        }
        .scrollable-container:active {
          cursor: grabbing;
        }
    </style>
</head>
<body>
    <header>
        <h1 id="app-company-name">Akuntansi Pintar</h1>
    </header>

    <main class="container">
        <nav class="tab-navigation">
            <button class="tab-button active" data-tab="kasir">
                <i data-feather="shopping-cart"></i> Kasir
            </button>
            <button class="tab-button" data-tab="produk">
                <i data-feather="box"></i> Produk
            </button>
            <button class="tab-button" data-tab="pengeluaran">
                <i data-feather="dollar-sign"></i> Pengeluaran
            </button>
            <button class="tab-button" data-tab="laporan">
                <i data-feather="file-text"></i> Laporan Penjualan
            </button>
            <button class="tab-button" data-tab="rekapan">
                <i data-feather="pie-chart"></i> Rekapan Keuangan
            </button>
            <button class="tab-button" data-tab="pengaturan">
                <i data-feather="settings"></i> Pengaturan
            </button>
        </nav>

        <div id="kasir" class="tab-content active">
            <div class="kasir-layout">
                <div class="left-panel">
                    <h2><i data-feather="tag"></i> Input Produk</h2>

                    <div class="form-group">
                        <label for="product-select">Pilih Produk:</label>
                        <select id="product-select">
                            <option value="">-- Pilih Produk --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="category-filter">Filter Kategori:</label>
                        <select id="category-filter">
                            <option value="">-- Semua Kategori --</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="product-name">Nama Produk:</label>
                        <input type="text" id="product-name" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-price">Harga (Rp):</label>
                        <input type="number" id="product-price" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-stock-display">Sisa Stok:</label>
                        <input type="text" id="product-stock-display" readonly placeholder="Akan terisi otomatis">
                    </div>
                    <div class="form-group">
                        <label for="product-quantity">Jumlah:</label>
                        <input type="number" id="product-quantity" value="1" min="1" placeholder="Jumlah produk">
                    </div>
                    <div class="button-group">
                        <button class="primary" id="add-to-cart-btn"><i data-feather="plus-circle"></i> Tambah ke Keranjang</button>
                        <button class="secondary" id="clear-input-btn"><i data-feather="refresh-cw"></i> Bersihkan Input</button>
                    </div>
                </div>

                <div class="right-panel">
                    <h2><i data-feather="shopping-bag"></i> Keranjang Belanja</h2>
                    <div class="cart-items scrollable-container">
                        <p class="empty-cart-message">Keranjang kosong. Pilih produk dari daftar.</p>
                    </div>
                    <div class="cart-summary">
                        <div class="summary-row">
                            <span>Subtotal:</span>
                            <span id="subtotal">Rp 0</span>
                        </div>
                        <div class="form-group">
                            <label for="discount-type">Jenis Diskon:</label>
                            <select id="discount-type">
                                <option value="none">Tidak Ada Diskon</option>
                                <option value="percentage">Persentase (%)</option>
                                <option value="nominal">Nominal (Rp)</option>
                            </select>
                        </div>
                        <div class="form-group" id="discount-value-group" style="display:none;">
                            <label for="discount-value">Nilai Diskon:</label>
                            <input type="number" id="discount-value" value="0" min="0" placeholder="Masukkan nilai diskon">
                        </div>
                        <div class="summary-row">
                            <span>Diskon:</span>
                            <span id="discount">Rp 0</span>
                        </div>
                        <div class="summary-row total">
                            <span>Total Pembayaran:</span>
                            <span id="total-payment">Rp 0</span>
                        </div>
                        <div class="form-group">
                            <label for="amount-paid">Jumlah Dibayar (Rp):</label>
                            <input type="number" id="amount-paid" value="0" min="0" placeholder="Masukkan jumlah uang dibayar">
                        </div>
                        <div class="summary-row total" id="change-row">
                            <span>Kembalian:</span>
                            <span id="change-amount">Rp 0</span>
                        </div>
                        <div class="button-group">
                            <button class="success" id="process-payment-btn"><i data-feather="dollar-sign"></i> Proses Pembayaran</button>
                            <button class="danger" id="clear-cart-btn"><i data-feather="trash-2"></i> Bersihkan Keranjang</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="produk" class="tab-content">
            <h2><i data-feather="database"></i> Manajemen Produk</h2>
            <div class="product-form-container">
                <div class="form-group">
                    <label for="new-product-name">Nama Produk Baru:</label>
                    <input type="text" id="new-product-name" placeholder="Contoh: Kopi Americano">
                </div>
                <div class="form-group">
                    <label for="new-product-category">Kategori:</label>
                    <input type="text" id="new-product-category" placeholder="Contoh: Minuman, Makanan">
                </div>
                <div class="form-group">
                    <label for="new-product-cost-price">Harga Beli (Rp):</label>
                    <input type="number" id="new-product-cost-price" min="0" value="0" placeholder="Harga beli produk">
                </div>
                <div class="form-group">
                    <label for="new-product-price">Harga Jual (Rp):</label>
                    <input type="number" id="new-product-price" min="0" value="0" placeholder="Harga jual produk">
                </div>
                <div class="form-group">
                    <label for="new-product-markup-percentage">Markup (%):</label>
                    <input type="number" id="new-product-markup-percentage" min="0" max="1000" step="0.01" readonly title="Markup dihitung otomatis (Harga Jual - Harga Beli) / Harga Beli * 100">
                </div>
                <div class="form-group">
                    <label for="new-product-stock">Stok Awal:</label>
                    <input type="number" id="new-product-stock" min="0" value="0" placeholder="Jumlah stok awal">
                </div>
                <div class="form-group">
                    <label for="new-product-min-stock">Min. Stok untuk Peringatan:</label>
                    <input type="number" id="new-product-min-stock" min="0" value="0" placeholder="Stok minimum untuk peringatan">
                </div>
                <div class="button-group">
                    <button class="primary" id="add-new-product-btn"><i data-feather="plus"></i> Tambah Produk Baru</button>
                </div>
            </div>

            <table id="product-table">
                <thead>
                    <tr>
                        <th>ID Produk</th>
                        <th>Nama</th>
                        <th>Kategori</th>
                        <th>Harga Beli</th>
                        <th>Harga Jual</th>
                        <th>Markup (%)</th>
                        <th>Stok</th>
                        <th>Min. Stok</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="product-list-body">
                    </tbody>
            </table>
        </div>

        <div id="pengeluaran" class="tab-content">
            <h2><i data-feather="minus-circle"></i> Manajemen Pengeluaran</h2>
            <div class="form-group">
                <label for="expense-date">Tanggal Pengeluaran:</label>
                <input type="date" id="expense-date" required>
            </div>
            <div class="form-group">
                <label for="expense-category">Kategori Pengeluaran:</label>
                <input type="text" id="expense-category" placeholder="Contoh: Sewa, Gaji, Listrik" required>
            </div>
            <div class="form-group">
                <label for="expense-description">Deskripsi:</label>
                <textarea id="expense-description" placeholder="Deskripsi detail pengeluaran" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="expense-amount">Jumlah (Rp):</label>
                <input type="number" id="expense-amount" min="0" value="0" required placeholder="Jumlah pengeluaran">
            </div>
            <div class="button-group">
                <button class="danger" id="add-expense-btn"><i data-feather="plus"></i> Tambah Pengeluaran</button>
            </div>

            <table id="expense-table">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Tanggal</th>
                        <th>Kategori</th>
                        <th>Deskripsi</th>
                        <th>Jumlah (Rp)</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="expense-list-body">
                    <p class="empty-table-message">Belum ada pengeluaran yang tercatat.</p>
                </tbody>
            </table>
        </div>

        <div id="laporan" class="tab-content">
            <h2><i data-feather="clipboard"></i> Laporan Penjualan</h2>
            <div class="form-group">
                <label for="report-date-filter">Filter Tanggal:</label>
                <input type="month" id="report-date-filter" title="Filter laporan berdasarkan bulan dan tahun">
            </div>
            <table id="transaction-table">
                <thead>
                    <tr>
                        <th>ID Transaksi</th>
                        <th>Tanggal</th>
                        <th>Total</th>
                        <th>Diskon</th>
                        <th>Aksi</th>
                    </tr>
                </thead>
                <tbody id="transaction-list-body">
                    </tbody>
            </table>
        </div>

        <div id="rekapan" class="tab-content">
            <h2><i data-feather="pie-chart"></i> Rekapan Keuangan Keseluruhan</h2>
            <div class="recap-summary" id="recap-summary-content">
                <div class="recap-card">
                    <h3>Total Pendapatan</h3>
                    <div class="amount" id="recap-revenue">Rp 0</div>
                </div>
                <div class="recap-card expense">
                    <h3>Total HPP</h3>
                    <div class="amount" id="recap-cost-of-goods">Rp 0</div>
                </div>
                 <div class="recap-card expense">
                    <h3>Total Pengeluaran</h3>
                    <div class="amount" id="recap-total-expense">Rp 0</div>
                </div>
                <div class="recap-card profit">
                    <h3>Laba Bersih</h3>
                    <div class="amount" id="recap-profit">Rp 0</div>
                </div>
            </div>

            <div class="chart-container">
                <h3 style="color: var(--primary-dark-gold); margin-bottom: 20px;">Grafik Pendapatan</h3>
                <div class="form-group" style="width: 100%; max-width: 300px; text-align: center;">
                    <label for="chart-filter">Tampilan Grafik:</label>
                    <select id="chart-filter">
                        <option value="daily">Harian (30 Hari Terakhir)</option>
                        <option value="weekly">Mingguan (12 Minggu Terakhir)</option>
                        <option value="monthly">Bulanan (12 Bulan Terakhir)</option>
                        <option value="yearly">Tahunan</option>
                    </select>
                </div>
                <canvas id="incomeTrendChart" aria-label="Grafik Tren Pendapatan" role="img"></canvas>
                <p id="chart-empty-message" class="empty-chart-message" style="display:none;">Tidak ada data transaksi untuk menampilkan grafik.</p>
            </div>
            </div>

        <div id="pengaturan" class="tab-content">
            <h2><i data-feather="settings"></i> Pengaturan Aplikasi</h2>

            <div class="settings-section">
                <h3>Nama Perusahaan</h3>
                <div class="form-group">
                    <label for="company-name-input">Nama Perusahaan/Toko:</label>
                    <input type="text" id="company-name-input" placeholder="Masukkan nama perusahaan Anda">
                </div>
                <div class="button-group">
                    <button class="primary" id="save-company-name-btn"><i data-feather="save"></i> Simpan Nama Perusahaan</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Custom Logo Cetak Struk</h3>
                <p class="settings-info">Masukkan URL gambar logo Anda. Logo akan tampil di atas struk cetak.</p>
                <div class="form-group">
                    <label for="receipt-logo-url-input">URL Logo:</label>
                    <input type="text" id="receipt-logo-url-input" placeholder="Contoh: https://example.com/logo.png">
                </div>
                <div class="button-group">
                    <button class="primary" id="save-receipt-logo-btn"><i data-feather="image"></i> Simpan Logo</button>
                    <button class="secondary" id="clear-receipt-logo-btn"><i data-feather="x-circle"></i> Hapus Logo</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Manajemen Pengguna <span style="font-weight: normal; font-size: 0.8em; color: var(--info-color);">(Admin Only)</span></h3>
                <p class="settings-info">Tambahkan pengguna baru atau lihat daftar pengguna. Untuk keamanan, aplikasi ini hanya menyimpan data di browser Anda.</p>
                <div class="form-group">
                    <label for="new-user-username">Username:</label>
                    <input type="text" id="new-user-username" placeholder="Masukkan username baru">
                </div>
                <div class="form-group">
                    <label for="new-user-password">Password:</label>
                    <input type="password" id="new-user-password" placeholder="Masukkan password">
                </div>
                <div class="form-group">
                    <label for="new-user-role">Peran:</label>
                    <select id="new-user-role">
                        <option value="kasir">Kasir</option>
                        <option value="admin">Admin</option>
                    </select>
                </div>
                <div class="button-group">
                    <button class="success" id="add-new-user-btn"><i data-feather="user-plus"></i> Tambah Pengguna Baru</button>
                </div>

                <h4 style="margin-top: 30px; border-bottom: 1px solid var(--border-color); padding-bottom: 10px; color: var(--text-color);">Daftar Pengguna</h4>
                <div id="user-list-display">
                    <p class="empty-table-message">Tidak ada pengguna lain. Admin default selalu ada.</p>
                </div>
            </div>

            <div class="settings-section">
                <h3>Ekspor Data ke PDF</h3>
                <p class="settings-info">Unduh data produk, laporan penjualan, atau daftar pengeluaran Anda dalam format PDF.</p>
                <div class="button-group">
                    <button class="info" id="export-products-pdf-btn"><i data-feather="download"></i> Produk (PDF)</button>
                    <button class="info" id="export-transactions-pdf-btn"><i data-feather="download"></i> Laporan Penjualan (PDF)</button>
                    <button class="info" id="export-expenses-pdf-btn"><i data-feather="download"></i> Pengeluaran (PDF)</button>
                    <button class="info" id="export-recap-pdf-btn"><i data-feather="download"></i> Rekapan Keuangan (PDF)</button>
                     <button class="info" id="export-chart-pdf-btn"><i data-feather="download"></i> Grafik Pendapatan (PDF)</button>
                </div>
            </div>

            <div class="settings-section">
                <h3>Hapus Semua Data Aplikasi</h3>
                <p class="settings-info" style="color: var(--danger-color); font-weight: 600;">
                    PERINGATAN: Tindakan ini akan menghapus SEMUA data aplikasi (produk, keranjang, transaksi, pengeluaran, dan pengguna lain) yang tersimpan di browser Anda. Tindakan ini TIDAK DAPAT DIBATALKAN!
                </p>
                <div class="button-group">
                    <button class="danger" id="clear-all-data-btn"><i data-feather="alert-triangle"></i> Hapus Semua Data Aplikasi</button>
                </div>
            </div>
        </div>

    </main>

    <div id="notification-area">
    </div>

    <div id="loginModal" class="modal active">
        <div class="modal-content login-modal-content">
            <h3>Selamat Datang di <span id="login-company-name-display">Akuntansi Pintar</span></h3>
            <p class="company-name">Sistem Keuangan Anda</p>
            <div class="form-group">
                <label for="login-username">Username:</label>
                <input type="text" id="login-username" placeholder="Username Anda">
            </div>
            <div class="form-group">
                <label for="login-password">Password:</label>
                <input type="password" id="login-password" placeholder="Password Anda">
            </div>
            <div class="button-group">
                <button class="primary" id="login-btn"><i data-feather="log-in"></i> Login</button>
            </div>
            <p class="info-text">Default Admin: username `admin`, password `admin123`</p>
        </div>
    </div>
    <div id="editProductModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Edit Produk</h3>
            <div class="form-group">
                <label for="modal-product-id">ID Produk:</label>
                <input type="text" id="modal-product-id" readonly>
            </div>
            <div class="form-group">
                <label for="modal-product-name">Nama Produk:</label>
                <input type="text" id="modal-product-name">
            </div>
            <div class="form-group">
                <label for="modal-product-category">Kategori:</label>
                <input type="text" id="modal-product-category">
            </div>
            <div class="form-group">
                <label for="modal-product-cost-price">Harga Beli (Rp):</label>
                <input type="number" id="modal-product-cost-price" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-price">Harga Jual (Rp):</label>
                <input type="number" id="modal-product-price" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-markup-percentage">Markup (%):</label>
                <input type="number" id="modal-product-markup-percentage" min="0" max="1000" step="0.01" readonly title="Markup dihitung otomatis (Harga Jual - Harga Beli) / Harga Beli * 100">
            </div>
            <div class="form-group">
                <label for="modal-product-stock">Stok:</label>
                <input type="number" id="modal-product-stock" min="0">
            </div>
            <div class="form-group">
                <label for="modal-product-min-stock">Min. Stok untuk Peringatan:</label>
                <input type="number" id="modal-product-min-stock" min="0">
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-edit-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-product-btn"><i data-feather="save"></i> Simpan Perubahan</button>
            </div>
        </div>
    </div>

    <div id="stockAdjustmentModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3 id="stock-modal-title">Penyesuaian Stok</h3>
            <p>Produk: <strong id="stock-product-name-display"></strong> (ID: <span id="stock-product-id-display"></span>)</p>
            <p>Stok Saat Ini: <strong id="current-stock-display"></strong></p>
            <div class="form-group">
                <label for="stock-adjustment-type">Jenis Penyesuaian:</label>
                <select id="stock-adjustment-type">
                    <option value="in">Barang Masuk (Tambah Stok)</option>
                    <option value="out">Barang Keluar (Kurangi Stok)</option>
                </select>
            </div>
            <div class="form-group">
                <label for="stock-adjustment-quantity">Jumlah:</label>
                <input type="number" id="stock-adjustment-quantity" min="1" value="1">
            </div>
            <div class="form-group">
                <label for="stock-adjustment-reason">Alasan (opsional):</label>
                <textarea id="stock-adjustment-reason" rows="2" placeholder="Contoh: Barang baru datang, Rusak, Retur"></textarea>
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-stock-adjustment-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-stock-adjustment-btn"><i data-feather="save"></i> Simpan</button>
            </div>
        </div>
    </div>

    <div id="transactionDetailModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Detail Transaksi</h3>
            <p><strong>ID Transaksi:</strong> <span id="detail-transaction-id"></span></p>
            <p><strong>Tanggal:</strong> <span id="detail-transaction-date"></span></p>
            <h4>Item:</h4>
            <ul id="detail-transaction-items"></ul>
            <div class="summary-row"><span>Subtotal:</span> <span id="detail-transaction-subtotal"></span></div>
            <div class="summary-row"><span>Diskon:</span> <span id="detail-transaction-discount">Rp 0</span></div>
            <div class="summary-row total"><span>Total:</span> <span id="detail-transaction-total"></span></div>
            <div class="summary-row"><span>Jumlah Dibayar:</span> <span id="detail-transaction-paid"></span></div>
            <div class="summary-row"><span>Kembalian:</span> <span id="detail-transaction-change"></span></div>
            <div class="button-group" style="justify-content: center;">
                <button class="info" id="close-detail-modal-btn"><i data-feather="x"></i> Tutup</button>
                <button class="primary" id="print-receipt-btn"><i data-feather="printer"></i> Cetak Struk</button>
            </div>
        </div>
    </div>

    <div id="editExpenseModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3>Edit Pengeluaran</h3>
            <div class="form-group">
                <label for="modal-expense-id">ID Pengeluaran:</label>
                <input type="text" id="modal-expense-id" readonly>
            </div>
            <div class="form-group">
                <label for="modal-expense-date">Tanggal:</label>
                <input type="date" id="modal-expense-date">
            </div>
            <div class="form-group">
                <label for="modal-expense-category">Kategori:</label>
                <input type="text" id="modal-expense-category">
            </div>
            <div class="form-group">
                <label for="modal-expense-description">Deskripsi:</label>
                <textarea id="modal-expense-description" rows="3"></textarea>
            </div>
            <div class="form-group">
                <label for="modal-expense-amount">Jumlah (Rp):</label>
                <input type="number" id="modal-expense-amount" min="0">
            </div>
            <div class="button-group">
                <button class="secondary" id="cancel-expense-edit-btn"><i data-feather="x-circle"></i> Batal</button>
                <button class="primary" id="save-expense-btn"><i data-feather="save"></i> Simpan Perubahan</button>
            </div>
        </div>
    </div>


    <div id="printReceiptContent" class="print-receipt-content" style="display:none;">
        <div class="receipt-logo-container">
            <img id="receipt-logo" src="" alt="Company Logo" style="max-width: 100px; max-height: 80px; display: none;">
        </div>
    </div>

    <div id="aboutUsModal" class="modal">
        <div class="modal-content">
            <span class="close-button" title="Tutup Modal">&times;</span>
            <h3><i data-feather="info"></i> Tentang Akuntansi Pintar</h3>
            <p><strong>Akuntansi Pintar</strong> versi 1.0.0</p>
            <p>Aplikasi ini dirancang untuk membantu para UMKM dalam hal pencatatan data keuangan usaha.</p>
            <p><strong>Pengembang Utama:</strong> Bagus Fathur</p>
            <p style="margin-left: 20px;">
                Telp: 087800149808<br>
                Email: <a href="mailto:fathurb100@gmail.com">fathurb100@gmail.com</a><br>
                TikTok: <a href="https://www.tiktok.com/@arcofartur" target="_blank">@arcofartur</a><br>
                Instagram: <a href="https://www.instagram.com/fathur_rc" target="_blank">fathur_Rc</a>
            </p>
            <p><strong>Berkolaborasi dengan:</strong> AI Gemini</p>
            <p><strong>Pengkoreksi:</strong> Yuniar Rachmalita</p>
            <p style="margin-left: 20px;">
                Email: <a href="mailto:yuniarrachmalita711@gmail.com">yuniarrachmalita711@gmail.com</a><br>
                TikTok: <a href="https://www.tiktok.com/@its_niarlt" target="_blank">@its_niarlt</a><br>
                Instagram: <a href="https://www.instagram.com/niarchmlt._" target="_blank">niarchmlt._</a>
            </p>
            <p><strong>Toko Penguji Pertama:</strong> Sinar Photo Copy</p>
            <p style="margin-left: 20px;">
                WhatsApp: <a href="https://wa.me/6285232347655" target="_blank">+62 852-3234-7655</a>
            </p>
            <div class="button-group" style="margin-top: 30px;">
                <button class="info" id="close-about-us-modal-btn"><i data-feather="x"></i> Tutup</button>
            </div>
        </div>
    </div>


    <footer>
        <p>&copy; 2025 <span id="footer-company-name">Akuntansi Pintar</span>. <a href="#" id="about-us-link">Tentang Kami</a>. Hak cipta dilindungi.</p>
    </footer>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- Data Storage (Local Storage) ---
            const STORAGE_KEYS = {
                PRODUCTS: 'products',
                TRANSACTIONS: 'transactions',
                EXPENSES: 'expenses',
                USERS: 'users',
                COMPANY_NAME: 'companyName',
                RECEIPT_LOGO_URL: 'receiptLogoUrl',
                CURRENT_USER: 'currentUser'
            };

            let products = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRODUCTS)) || [];
            let transactions = JSON.parse(localStorage.getItem(STORAGE_KEYS.TRANSACTIONS)) || [];
            let expenses = JSON.parse(localStorage.getItem(STORAGE_KEYS.EXPENSES)) || [];
            let users = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [
                { username: 'admin', password: 'admin123', role: 'admin' }
            ];
            let companyName = localStorage.getItem(STORAGE_KEYS.COMPANY_NAME) || 'Akuntansi Pintar';
            let receiptLogoUrl = localStorage.getItem(STORAGE_KEYS.RECEIPT_LOGO_URL) || '';
            let currentUser = JSON.parse(localStorage.getItem(STORAGE_KEYS.CURRENT_USER));

            let cart = [];
            let editingProductId = null;
            let editingExpenseId = null;
            let currentChart = null; // To store the Chart.js instance

            // --- Helper Functions ---
            const saveToLocalStorage = (key, data) => {
                localStorage.setItem(key, JSON.stringify(data));
            };

            const formatCurrency = (amount) => {
                return new Intl.NumberFormat('id-ID', {
                    style: 'currency',
                    currency: 'IDR',
                    minimumFractionDigits: 0,
                    maximumFractionDigits: 0
                }).format(amount);
            };

            const showNotification = (message, type = 'info', duration = 3000) => {
                const notificationArea = document.getElementById('notification-area');
                const notification = document.createElement('div');
                notification.className = `notification ${type}`;
                notification.textContent = message;
                notification.style.setProperty('--notification-duration', `${duration / 1000}s`);

                notificationArea.appendChild(notification);

                setTimeout(() => {
                    notification.style.opacity = '1';
                    notification.style.transform = 'translateX(0)';
                }, 10); // Small delay for animation to start

                setTimeout(() => {
                    notification.style.opacity = '0';
                    notification.style.transform = 'translateX(100%)';
                    notification.addEventListener('transitionend', () => {
                        notification.remove();
                    }, { once: true });
                }, duration - 500); // Start fading out before full duration
            };

            const generateUniqueId = (prefix) => {
                return `${prefix}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            };

            const calculateMarkupPercentage = (costPrice, sellingPrice) => {
                if (costPrice <= 0) return 0;
                return ((sellingPrice - costPrice) / costPrice) * 100;
            };

            // --- Login/Logout Logic ---
            const loginModal = document.getElementById('loginModal');
            const loginUsernameInput = document.getElementById('login-username');
            const loginPasswordInput = document.getElementById('login-password');
            const loginBtn = document.getElementById('login-btn');
            const loginCompanyNameDisplay = document.getElementById('login-company-name-display');

            const updateCompanyNameDisplay = () => {
                document.getElementById('app-company-name').textContent = companyName;
                document.getElementById('footer-company-name').textContent = companyName;
                loginCompanyNameDisplay.textContent = companyName;
            };

            const updateTabVisibility = () => {
                const tabButtons = document.querySelectorAll('.tab-button');
                tabButtons.forEach(button => {
                    const tabId = button.dataset.tab;
                    if (currentUser && currentUser.role === 'kasir') {
                        if (tabId === 'produk' || tabId === 'pengeluaran' || tabId === 'laporan' || tabId === 'rekapan' || tabId === 'pengaturan') {
                            button.style.display = 'none';
                        } else {
                            button.style.display = 'flex';
                        }
                    } else { // Admin or not logged in (should be hidden by modal)
                        button.style.display = 'flex';
                    }
                });

                // Hide main content if not logged in
                const mainContainer = document.querySelector('main.container');
                if (!currentUser) {
                    mainContainer.style.display = 'none';
                } else {
                    mainContainer.style.display = 'flex';
                    // If kasir is logged in and current tab is restricted, switch to kasir tab
                    const activeTabButton = document.querySelector('.tab-button.active');
                    if (currentUser.role === 'kasir' && activeTabButton && (activeTabButton.dataset.tab === 'produk' || activeTabButton.dataset.tab === 'pengeluaran' || activeTabButton.dataset.tab === 'laporan' || activeTabButton.dataset.tab === 'rekapan' || activeTabButton.dataset.tab === 'pengaturan')) {
                        document.querySelector('.tab-button[data-tab="kasir"]').click();
                    }
                }
            };

            const handleLogin = () => {
                const username = loginUsernameInput.value;
                const password = loginPasswordInput.value;

                const user = users.find(u => u.username === username && u.password === password);

                if (user) {
                    currentUser = user;
                    saveToLocalStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
                    loginModal.classList.remove('active');
                    showNotification(`Selamat datang, ${currentUser.username}!`, 'success');
                    updateTabVisibility();
                    updateUserInfoDisplay();
                    // Re-render relevant sections after login
                    renderProductList();
                    renderExpenseList();
                    renderTransactionList();
                    updateRecapSummary();
                    renderIncomeTrendChart();
                    renderUserList(); // Render user list for admin
                } else {
                    showNotification('Username atau password salah!', 'error');
                }
            };

            const handleLogout = () => {
                currentUser = null;
                localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
                showNotification('Anda telah logout.', 'info');
                loginModal.classList.add('active'); // Show login modal
                updateTabVisibility();
                updateUserInfoDisplay();
                // Clear sensitive data on logout if necessary (e.g., cart)
                cart = [];
                renderCart();
            };

            // User Info Display (for logout button and current user)
            const userInfoDiv = document.createElement('div');
            userInfoDiv.id = 'user-info';
            userInfoDiv.style.cssText = 'position: absolute; top: 20px; right: 30px; display: flex; align-items: center; gap: 10px; color: white; z-index: 10;';
            userInfoDiv.innerHTML = `
                <span id="current-user-name" style="font-weight: 600;"></span>
                <button id="logout-btn" class="danger" style="padding: 8px 15px; font-size: 0.9em; border-radius: 8px; box-shadow: none; transform: none; background: rgba(255,255,255,0.2); color: white;">
                    <i data-feather="log-out"></i> Logout
                </button>
            `;
            document.querySelector('header').appendChild(userInfoDiv);
            feather.replace(); // Re-render icons for newly added element

            const updateUserInfoDisplay = () => {
                const currentUserSpan = document.getElementById('current-user-name');
                const logoutBtn = document.getElementById('logout-btn');

                if (currentUser) {
                    currentUserSpan.textContent = `Login sebagai: ${currentUser.username} (${currentUser.role})`;
                    userInfoDiv.style.display = 'flex';
                    logoutBtn.addEventListener('click', handleLogout); // Attach listener here
                } else {
                    currentUserSpan.textContent = '';
                    userInfoDiv.style.display = 'none';
                    logoutBtn.removeEventListener('click', handleLogout); // Remove listener if not logged in
                }
            };

            // --- Tab Navigation ---
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', () => {
                    const tabId = button.dataset.tab;

                    // Check role access
                    if (currentUser && currentUser.role === 'kasir') {
                        if (tabId === 'produk' || tabId === 'pengeluaran' || tabId === 'laporan' || tabId === 'rekapan' || tabId === 'pengaturan') {
                            showNotification('Anda tidak memiliki akses ke tab ini.', 'warning');
                            return;
                        }
                    }

                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    button.classList.add('active');
                    document.getElementById(tabId).classList.add('active');

                    // Re-render specific content when tab is activated
                    if (tabId === 'produk') {
                        renderProductList();
                    } else if (tabId === 'pengeluaran') {
                        renderExpenseList();
                    } else if (tabId === 'laporan') {
                        renderTransactionList();
                    } else if (tabId === 'rekapan') {
                        updateRecapSummary();
                        renderIncomeTrendChart();
                    } else if (tabId === 'pengaturan') {
                        renderUserList();
                    }
                    feather.replace(); // Re-render icons
                });
            });

            // --- Kasir Tab Logic ---
            const productSelect = document.getElementById('product-select');
            const categoryFilter = document.getElementById('category-filter');
            const productNameInput = document.getElementById('product-name');
            const productPriceInput = document.getElementById('product-price');
            const productStockDisplay = document.getElementById('product-stock-display');
            const productQuantityInput = document.getElementById('product-quantity');
            const addToCartBtn = document.getElementById('add-to-cart-btn');
            const clearInputBtn = document.getElementById('clear-input-btn');
            const cartItemsContainer = document.querySelector('.cart-items');
            const subtotalSpan = document.getElementById('subtotal');
            const discountTypeSelect = document.getElementById('discount-type');
            const discountValueGroup = document.getElementById('discount-value-group');
            const discountValueInput = document.getElementById('discount-value');
            const discountSpan = document.getElementById('discount');
            const totalPaymentSpan = document.getElementById('total-payment');
            const amountPaidInput = document.getElementById('amount-paid');
            const changeAmountSpan = document.getElementById('change-amount');
            const changeRow = document.getElementById('change-row');
            const processPaymentBtn = document.getElementById('process-payment-btn');
            const clearCartBtn = document.getElementById('clear-cart-btn');
            const emptyCartMessage = document.querySelector('.empty-cart-message');

            const populateProductSelect = (filterCategory = '') => {
                productSelect.innerHTML = '<option value="">-- Pilih Produk --</option>';
                const uniqueCategories = new Set();

                products.forEach(product => {
                    uniqueCategories.add(product.category);
                    if (!filterCategory || product.category === filterCategory) {
                        const option = document.createElement('option');
                        option.value = product.id;
                        option.textContent = `${product.name} (Stok: ${product.stock})`;
                        productSelect.appendChild(option);
                    }
                });

                // Populate category filter if not already done
                if (categoryFilter.options.length <= 1) {
                    categoryFilter.innerHTML = '<option value="">-- Semua Kategori --</option>';
                    uniqueCategories.forEach(category => {
                        const option = document.createElement('option');
                        option.value = category;
                        option.textContent = category;
                        categoryFilter.appendChild(option);
                    });
                }
            };

            productSelect.addEventListener('change', () => {
                const selectedProductId = productSelect.value;
                const selectedProduct = products.find(p => p.id === selectedProductId);

                if (selectedProduct) {
                    productNameInput.value = selectedProduct.name;
                    productPriceInput.value = selectedProduct.price;
                    productStockDisplay.value = selectedProduct.stock;
                    productQuantityInput.value = 1; // Reset quantity
                    productQuantityInput.max = selectedProduct.stock; // Set max quantity based on stock
                } else {
                    productNameInput.value = '';
                    productPriceInput.value = '';
                    productStockDisplay.value = '';
                    productQuantityInput.value = 1;
                    productQuantityInput.max = '';
                }
            });

            categoryFilter.addEventListener('change', () => {
                const selectedCategory = categoryFilter.value;
                populateProductSelect(selectedCategory);
                // Clear product selection when category filter changes
                productSelect.value = '';
                productNameInput.value = '';
                productPriceInput.value = '';
                productStockDisplay.value = '';
                productQuantityInput.value = 1;
                productQuantityInput.max = '';
            });

            addToCartBtn.addEventListener('click', () => {
                const selectedProductId = productSelect.value;
                const quantity = parseInt(productQuantityInput.value);

                if (!selectedProductId || isNaN(quantity) || quantity <= 0) {
                    showNotification('Pilih produk dan masukkan jumlah yang valid.', 'warning');
                    return;
                }

                const productToAdd = products.find(p => p.id === selectedProductId);

                if (!productToAdd) {
                    showNotification('Produk tidak ditemukan.', 'error');
                    return;
                }

                if (productToAdd.stock < quantity) {
                    showNotification(`Stok ${productToAdd.name} tidak mencukupi. Tersedia: ${productToAdd.stock}`, 'warning');
                    return;
                }

                const existingCartItem = cart.find(item => item.id === selectedProductId);

                if (existingCartItem) {
                    const newQuantity = existingCartItem.quantity + quantity;
                    if (productToAdd.stock < newQuantity) {
                        showNotification(`Penambahan melebihi stok. Stok ${productToAdd.name} tersisa: ${productToAdd.stock}`, 'warning');
                        return;
                    }
                    existingCartItem.quantity = newQuantity;
                } else {
                    cart.push({
                        id: productToAdd.id,
                        name: productToAdd.name,
                        price: productToAdd.price,
                        costPrice: productToAdd.costPrice, // Include cost price for HPP calculation
                        quantity: quantity
                    });
                }

                productToAdd.stock -= quantity; // Deduct stock immediately
                saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);

                renderCart();
                clearKasirInput();
                showNotification(`${quantity}x ${productToAdd.name} ditambahkan ke keranjang.`, 'success');
                populateProductSelect(categoryFilter.value); // Update stock display in select
            });

            clearInputBtn.addEventListener('click', clearKasirInput);

            function clearKasirInput() {
                productSelect.value = '';
                productNameInput.value = '';
                productPriceInput.value = '';
                productStockDisplay.value = '';
                productQuantityInput.value = 1;
                productQuantityInput.max = '';
                categoryFilter.value = ''; // Reset category filter too
                populateProductSelect(); // Repopulate product select without filter
            }

            const renderCart = () => {
                cartItemsContainer.innerHTML = '';
                if (cart.length === 0) {
                    emptyCartMessage.style.display = 'block';
                    cartItemsContainer.appendChild(emptyCartMessage);
                } else {
                    emptyCartMessage.style.display = 'none';
                    cart.forEach(item => {
                        const cartItemDiv = document.createElement('div');
                        cartItemDiv.className = 'cart-item';
                        cartItemDiv.innerHTML = `
                            <div class="cart-item-info">
                                <div class="cart-item-name">${item.name}</div>
                                <div class="cart-item-quantity">${item.quantity} x ${formatCurrency(item.price)}</div>
                            </div>
                            <div class="cart-item-total-price">${formatCurrency(item.quantity * item.price)}</div>
                            <div class="cart-item-actions">
                                <button class="danger" data-id="${item.id}" data-action="remove"><i data-feather="trash-2"></i></button>
                            </div>
                        `;
                        cartItemsContainer.appendChild(cartItemDiv);
                    });
                }
                feather.replace(); // Re-render icons for newly added elements
                calculateSummary();
            };

            cartItemsContainer.addEventListener('click', (event) => {
                if (event.target.closest('button[data-action="remove"]')) {
                    const productId = event.target.closest('button').dataset.id;
                    const itemIndex = cart.findIndex(item => item.id === productId);

                    if (itemIndex > -1) {
                        const removedItem = cart[itemIndex];
                        const productInStock = products.find(p => p.id === removedItem.id);
                        if (productInStock) {
                            productInStock.stock += removedItem.quantity; // Return stock
                        }
                        cart.splice(itemIndex, 1);
                        saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                        renderCart();
                        populateProductSelect(categoryFilter.value); // Update stock display in select
                        showNotification(`${removedItem.name} dihapus dari keranjang.`, 'info');
                    }
                }
            });

            discountTypeSelect.addEventListener('change', () => {
                if (discountTypeSelect.value === 'none') {
                    discountValueGroup.style.display = 'none';
                    discountValueInput.value = 0;
                } else {
                    discountValueGroup.style.display = 'block';
                    discountValueInput.value = 0;
                }
                calculateSummary();
            });

            discountValueInput.addEventListener('input', calculateSummary);
            amountPaidInput.addEventListener('input', calculateSummary);

            const calculateSummary = () => {
                let subtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                let discountAmount = 0;
                const discountType = discountTypeSelect.value;
                let discountValue = parseFloat(discountValueInput.value) || 0;

                if (discountType === 'percentage') {
                    discountAmount = subtotal * (discountValue / 100);
                } else if (discountType === 'nominal') {
                    discountAmount = discountValue;
                }

                let total = subtotal - discountAmount;
                if (total < 0) total = 0; // Prevent negative total

                let amountPaid = parseFloat(amountPaidInput.value) || 0;
                let change = amountPaid - total;

                subtotalSpan.textContent = formatCurrency(subtotal);
                discountSpan.textContent = formatCurrency(discountAmount);
                totalPaymentSpan.textContent = formatCurrency(total);
                changeAmountSpan.textContent = formatCurrency(change);

                if (change < 0) {
                    changeRow.classList.add('change-negative');
                    changeRow.classList.remove('change-positive');
                } else {
                    changeRow.classList.remove('change-negative');
                    changeRow.classList.add('change-positive');
                }
            };

            processPaymentBtn.addEventListener('click', () => {
                if (cart.length === 0) {
                    showNotification('Keranjang belanja kosong!', 'warning');
                    return;
                }

                const total = parseFloat(totalPaymentSpan.textContent.replace(/[^0-9,-]+/g, "").replace(',', '.'));
                const amountPaid = parseFloat(amountPaidInput.value);

                if (isNaN(amountPaid) || amountPaid < total) {
                    showNotification('Jumlah dibayar tidak mencukupi!', 'warning');
                    return;
                }

                const transactionId = generateUniqueId('TRX');
                const transactionDate = new Date().toISOString();
                const transactionItems = cart.map(item => ({
                    id: item.id,
                    name: item.name,
                    quantity: item.quantity,
                    price: item.price,
                    costPrice: item.costPrice // Store cost price at time of transaction
                }));
                const transactionSubtotal = cart.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                const transactionDiscount = parseFloat(discountSpan.textContent.replace(/[^0-9,-]+/g, "").replace(',', '.'));
                const transactionTotal = total;
                const transactionPaid = amountPaid;
                const transactionChange = amountPaid - total;

                const newTransaction = {
                    id: transactionId,
                    date: transactionDate,
                    items: transactionItems,
                    subtotal: transactionSubtotal,
                    discount: transactionDiscount,
                    total: transactionTotal,
                    paid: transactionPaid,
                    change: transactionChange
                };

                transactions.push(newTransaction);
                saveToLocalStorage(STORAGE_KEYS.TRANSACTIONS, transactions);

                showNotification('Pembayaran berhasil!', 'success');
                showTransactionDetailModal(newTransaction); // Show detail and print receipt option
                cart = []; // Clear cart after successful payment
                renderCart();
                clearKasirInput();
                populateProductSelect(); // Update product stock display
                updateRecapSummary(); // Update recap summary
                renderIncomeTrendChart(); // Update chart
            });

            clearCartBtn.addEventListener('click', () => {
                if (confirm('Apakah Anda yakin ingin membersihkan seluruh keranjang? Stok produk akan dikembalikan.')) {
                    cart.forEach(item => {
                        const productInStock = products.find(p => p.id === item.id);
                        if (productInStock) {
                            productInStock.stock += item.quantity; // Return stock
                        }
                    });
                    cart = [];
                    saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                    renderCart();
                    clearKasirInput();
                    populateProductSelect(); // Update stock display in select
                    showNotification('Keranjang telah dibersihkan.', 'info');
                }
            });

            // --- Produk Tab Logic ---
            const newProductNameInput = document.getElementById('new-product-name');
            const newProductCategoryInput = document.getElementById('new-product-category');
            const newProductCostPriceInput = document.getElementById('new-product-cost-price');
            const newProductPriceInput = document.getElementById('new-product-price');
            const newProductMarkupPercentageInput = document.getElementById('new-product-markup-percentage');
            const newProductStockInput = document.getElementById('new-product-stock');
            const newProductMinStockInput = document.getElementById('new-product-min-stock');
            const addNewProductBtn = document.getElementById('add-new-product-btn');
            const productListBody = document.getElementById('product-list-body');

            // Calculate markup percentage on input change
            newProductCostPriceInput.addEventListener('input', () => {
                const cost = parseFloat(newProductCostPriceInput.value);
                const price = parseFloat(newProductPriceInput.value);
                newProductMarkupPercentageInput.value = calculateMarkupPercentage(cost, price).toFixed(2);
            });

            newProductPriceInput.addEventListener('input', () => {
                const cost = parseFloat(newProductCostPriceInput.value);
                const price = parseFloat(newProductPriceInput.value);
                newProductMarkupPercentageInput.value = calculateMarkupPercentage(cost, price).toFixed(2);
            });

            addNewProductBtn.addEventListener('click', () => {
                const name = newProductNameInput.value.trim();
                const category = newProductCategoryInput.value.trim();
                const costPrice = parseFloat(newProductCostPriceInput.value);
                const price = parseFloat(newProductPriceInput.value);
                const stock = parseInt(newProductStockInput.value);
                const minStock = parseInt(newProductMinStockInput.value);

                if (!name || !category || isNaN(costPrice) || costPrice < 0 || isNaN(price) || price < 0 || isNaN(stock) || stock < 0 || isNaN(minStock) || minStock < 0) {
                    showNotification('Mohon lengkapi semua data produk dengan benar.', 'warning');
                    return;
                }

                if (price < costPrice) {
                    showNotification('Harga jual tidak boleh lebih rendah dari harga beli.', 'warning');
                    return;
                }

                const newProduct = {
                    id: generateUniqueId('PROD'),
                    name,
                    category,
                    costPrice,
                    price,
                    stock,
                    minStock
                };

                products.push(newProduct);
                saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                renderProductList();
                populateProductSelect(); // Update product select in Kasir tab
                showNotification(`${name} berhasil ditambahkan!`, 'success');
                clearProductForm();
            });

            function clearProductForm() {
                newProductNameInput.value = '';
                newProductCategoryInput.value = '';
                newProductCostPriceInput.value = 0;
                newProductPriceInput.value = 0;
                newProductMarkupPercentageInput.value = 0;
                newProductStockInput.value = 0;
                newProductMinStockInput.value = 0;
            }

            const renderProductList = () => {
                productListBody.innerHTML = '';
                if (products.length === 0) {
                    productListBody.innerHTML = `<tr><td colspan="9" class="empty-table-message">Belum ada produk yang tercatat.</td></tr>`;
                    return;
                }
                products.forEach(product => {
                    const markup = calculateMarkupPercentage(product.costPrice, product.price);
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${product.id}</td>
                        <td>${product.name}</td>
                        <td>${product.category}</td>
                        <td>${formatCurrency(product.costPrice)}</td>
                        <td>${formatCurrency(product.price)}</td>
                        <td>${markup.toFixed(2)}%</td>
                        <td style="color: ${product.stock <= product.minStock ? 'var(--danger-color)' : 'inherit'}; font-weight: ${product.stock <= product.minStock ? 'bold' : 'normal'};">
                            ${product.stock} ${product.stock <= product.minStock ? '<i data-feather="alert-triangle" title="Stok rendah!"></i>' : ''}
                        </td>
                        <td>${product.minStock}</td>
                        <td class="table-actions">
                            <button class="primary" data-id="${product.id}" data-action="edit"><i data-feather="edit"></i> Edit</button>
                            <button class="info" data-id="${product.id}" data-action="adjust-stock"><i data-feather="package"></i> Stok</button>
                            <button class="danger" data-id="${product.id}" data-action="delete"><i data-feather="trash-2"></i> Hapus</button>
                        </td>
                    `;
                    productListBody.appendChild(row);
                });
                feather.replace(); // Re-render icons
            };

            productListBody.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const productId = targetButton.dataset.id;
                const action = targetButton.dataset.action;

                if (action === 'edit') {
                    openEditProductModal(productId);
                } else if (action === 'adjust-stock') {
                    openStockAdjustmentModal(productId);
                } else if (action === 'delete') {
                    if (confirm('Apakah Anda yakin ingin menghapus produk ini?')) {
                        products = products.filter(p => p.id !== productId);
                        saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                        renderProductList();
                        populateProductSelect(); // Update product select in Kasir tab
                        showNotification('Produk berhasil dihapus.', 'info');
                    }
                }
            });

            // --- Edit Product Modal Logic ---
            const editProductModal = document.getElementById('editProductModal');
            const modalProductId = document.getElementById('modal-product-id');
            const modalProductName = document.getElementById('modal-product-name');
            const modalProductCategory = document.getElementById('modal-product-category');
            const modalProductCostPrice = document.getElementById('modal-product-cost-price');
            const modalProductPrice = document.getElementById('modal-product-price');
            const modalProductMarkupPercentage = document.getElementById('modal-product-markup-percentage');
            const modalProductStock = document.getElementById('modal-product-stock');
            const modalProductMinStock = document.getElementById('modal-product-min-stock');
            const saveProductBtn = document.getElementById('save-product-btn');
            const cancelEditBtn = document.getElementById('cancel-edit-btn');

            modalProductCostPrice.addEventListener('input', () => {
                const cost = parseFloat(modalProductCostPrice.value);
                const price = parseFloat(modalProductPrice.value);
                modalProductMarkupPercentage.value = calculateMarkupPercentage(cost, price).toFixed(2);
            });

            modalProductPrice.addEventListener('input', () => {
                const cost = parseFloat(modalProductCostPrice.value);
                const price = parseFloat(modalProductPrice.value);
                modalProductMarkupPercentage.value = calculateMarkupPercentage(cost, price).toFixed(2);
            });

            const openEditProductModal = (productId) => {
                editingProductId = productId;
                const product = products.find(p => p.id === productId);
                if (product) {
                    modalProductId.value = product.id;
                    modalProductName.value = product.name;
                    modalProductCategory.value = product.category;
                    modalProductCostPrice.value = product.costPrice;
                    modalProductPrice.value = product.price;
                    modalProductMarkupPercentage.value = calculateMarkupPercentage(product.costPrice, product.price).toFixed(2);
                    modalProductStock.value = product.stock;
                    modalProductMinStock.value = product.minStock;
                    editProductModal.classList.add('active');
                }
            };

            saveProductBtn.addEventListener('click', () => {
                const productIndex = products.findIndex(p => p.id === editingProductId);
                if (productIndex > -1) {
                    const updatedProduct = {
                        ...products[productIndex],
                        name: modalProductName.value.trim(),
                        category: modalProductCategory.value.trim(),
                        costPrice: parseFloat(modalProductCostPrice.value),
                        price: parseFloat(modalProductPrice.value),
                        stock: parseInt(modalProductStock.value),
                        minStock: parseInt(modalProductMinStock.value)
                    };

                    if (!updatedProduct.name || !updatedProduct.category || isNaN(updatedProduct.costPrice) || updatedProduct.costPrice < 0 || isNaN(updatedProduct.price) || updatedProduct.price < 0 || isNaN(updatedProduct.stock) || updatedProduct.stock < 0 || isNaN(updatedProduct.minStock) || updatedProduct.minStock < 0) {
                        showNotification('Mohon lengkapi semua data produk dengan benar.', 'warning');
                        return;
                    }
                    if (updatedProduct.price < updatedProduct.costPrice) {
                        showNotification('Harga jual tidak boleh lebih rendah dari harga beli.', 'warning');
                        return;
                    }

                    products[productIndex] = updatedProduct;
                    saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                    renderProductList();
                    populateProductSelect(); // Update product select in Kasir tab
                    editProductModal.classList.remove('active');
                    showNotification('Produk berhasil diperbarui.', 'success');
                }
            });

            cancelEditBtn.addEventListener('click', () => {
                editProductModal.classList.remove('active');
                editingProductId = null;
            });

            // --- Stock Adjustment Modal Logic ---
            const stockAdjustmentModal = document.getElementById('stockAdjustmentModal');
            const stockModalTitle = document.getElementById('stock-modal-title');
            const stockProductNameDisplay = document.getElementById('stock-product-name-display');
            const stockProductIdDisplay = document.getElementById('stock-product-id-display');
            const currentStockDisplay = document.getElementById('current-stock-display');
            const stockAdjustmentType = document.getElementById('stock-adjustment-type');
            const stockAdjustmentQuantity = document.getElementById('stock-adjustment-quantity');
            const stockAdjustmentReason = document.getElementById('stock-adjustment-reason');
            const saveStockAdjustmentBtn = document.getElementById('save-stock-adjustment-btn');
            const cancelStockAdjustmentBtn = document.getElementById('cancel-stock-adjustment-btn');

            const openStockAdjustmentModal = (productId) => {
                editingProductId = productId; // Use editingProductId for stock adjustment too
                const product = products.find(p => p.id === productId);
                if (product) {
                    stockProductNameDisplay.textContent = product.name;
                    stockProductIdDisplay.textContent = product.id;
                    currentStockDisplay.textContent = product.stock;
                    stockAdjustmentQuantity.value = 1;
                    stockAdjustmentReason.value = '';
                    stockAdjustmentType.value = 'in'; // Default to 'in'
                    stockAdjustmentModal.classList.add('active');
                }
            };

            saveStockAdjustmentBtn.addEventListener('click', () => {
                const productIndex = products.findIndex(p => p.id === editingProductId);
                if (productIndex > -1) {
                    const product = products[productIndex];
                    const type = stockAdjustmentType.value;
                    const quantity = parseInt(stockAdjustmentQuantity.value);
                    const reason = stockAdjustmentReason.value.trim();

                    if (isNaN(quantity) || quantity <= 0) {
                        showNotification('Jumlah penyesuaian harus angka positif.', 'warning');
                        return;
                    }

                    if (type === 'in') {
                        product.stock += quantity;
                        showNotification(`Stok ${product.name} ditambahkan ${quantity}.`, 'success');
                    } else if (type === 'out') {
                        if (product.stock < quantity) {
                            showNotification(`Stok ${product.name} tidak cukup untuk dikurangi ${quantity}. Stok saat ini: ${product.stock}`, 'warning');
                            return;
                        }
                        product.stock -= quantity;
                        showNotification(`Stok ${product.name} dikurangi ${quantity}.`, 'info');
                    }

                    // Optionally, you could log stock adjustments as expenses or separate records
                    // For simplicity, we just update stock and notify.

                    saveToLocalStorage(STORAGE_KEYS.PRODUCTS, products);
                    renderProductList();
                    populateProductSelect(); // Update product select in Kasir tab
                    stockAdjustmentModal.classList.remove('active');
                    editingProductId = null;
                }
            });

            cancelStockAdjustmentBtn.addEventListener('click', () => {
                stockAdjustmentModal.classList.remove('active');
                editingProductId = null;
            });


            // --- Pengeluaran Tab Logic ---
            const expenseDateInput = document.getElementById('expense-date');
            const expenseCategoryInput = document.getElementById('expense-category');
            const expenseDescriptionInput = document.getElementById('expense-description');
            const expenseAmountInput = document.getElementById('expense-amount');
            const addExpenseBtn = document.getElementById('add-expense-btn');
            const expenseListBody = document.getElementById('expense-list-body');

            // Set default date to today
            expenseDateInput.valueAsDate = new Date();

            addExpenseBtn.addEventListener('click', () => {
                const date = expenseDateInput.value;
                const category = expenseCategoryInput.value.trim();
                const description = expenseDescriptionInput.value.trim();
                const amount = parseFloat(expenseAmountInput.value);

                if (!date || !category || isNaN(amount) || amount <= 0) {
                    showNotification('Mohon lengkapi tanggal, kategori, dan jumlah pengeluaran dengan benar.', 'warning');
                    return;
                }

                const newExpense = {
                    id: generateUniqueId('EXP'),
                    date,
                    category,
                    description,
                    amount
                };

                expenses.push(newExpense);
                saveToLocalStorage(STORAGE_KEYS.EXPENSES, expenses);
                renderExpenseList();
                updateRecapSummary(); // Update recap summary
                showNotification('Pengeluaran berhasil ditambahkan!', 'success');
                clearExpenseForm();
            });

            function clearExpenseForm() {
                expenseDateInput.valueAsDate = new Date(); // Reset to today
                expenseCategoryInput.value = '';
                expenseDescriptionInput.value = '';
                expenseAmountInput.value = 0;
            }

            const renderExpenseList = () => {
                expenseListBody.innerHTML = '';
                if (expenses.length === 0) {
                    expenseListBody.innerHTML = `<tr><td colspan="6" class="empty-table-message">Belum ada pengeluaran yang tercatat.</td></tr>`;
                    return;
                }
                expenses.sort((a, b) => new Date(b.date) - new Date(a.date)); // Sort by date descending
                expenses.forEach(expense => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${expense.id}</td>
                        <td>${new Date(expense.date).toLocaleDateString('id-ID')}</td>
                        <td>${expense.category}</td>
                        <td>${expense.description || '-'}</td>
                        <td>${formatCurrency(expense.amount)}</td>
                        <td class="table-actions">
                            <button class="primary" data-id="${expense.id}" data-action="edit-expense"><i data-feather="edit"></i> Edit</button>
                            <button class="danger" data-id="${expense.id}" data-action="delete-expense"><i data-feather="trash-2"></i> Hapus</button>
                        </td>
                    `;
                    expenseListBody.appendChild(row);
                });
                feather.replace(); // Re-render icons
            };

            expenseListBody.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const expenseId = targetButton.dataset.id;
                const action = targetButton.dataset.action;

                if (action === 'edit-expense') {
                    openEditExpenseModal(expenseId);
                } else if (action === 'delete-expense') {
                    if (confirm('Apakah Anda yakin ingin menghapus pengeluaran ini?')) {
                        expenses = expenses.filter(e => e.id !== expenseId);
                        saveToLocalStorage(STORAGE_KEYS.EXPENSES, expenses);
                        renderExpenseList();
                        updateRecapSummary(); // Update recap summary
                        showNotification('Pengeluaran berhasil dihapus.', 'info');
                    }
                }
            });

            // --- Edit Expense Modal Logic ---
            const editExpenseModal = document.getElementById('editExpenseModal');
            const modalExpenseId = document.getElementById('modal-expense-id');
            const modalExpenseDate = document.getElementById('modal-expense-date');
            const modalExpenseCategory = document.getElementById('modal-expense-category');
            const modalExpenseDescription = document.getElementById('modal-expense-description');
            const modalExpenseAmount = document.getElementById('modal-expense-amount');
            const saveExpenseBtn = document.getElementById('save-expense-btn');
            const cancelExpenseEditBtn = document.getElementById('cancel-expense-edit-btn');

            const openEditExpenseModal = (expenseId) => {
                editingExpenseId = expenseId;
                const expense = expenses.find(e => e.id === expenseId);
                if (expense) {
                    modalExpenseId.value = expense.id;
                    modalExpenseDate.value = expense.date;
                    modalExpenseCategory.value = expense.category;
                    modalExpenseDescription.value = expense.description;
                    modalExpenseAmount.value = expense.amount;
                    editExpenseModal.classList.add('active');
                }
            };

            saveExpenseBtn.addEventListener('click', () => {
                const expenseIndex = expenses.findIndex(e => e.id === editingExpenseId);
                if (expenseIndex > -1) {
                    const updatedExpense = {
                        ...expenses[expenseIndex],
                        date: modalExpenseDate.value,
                        category: modalExpenseCategory.value.trim(),
                        description: modalExpenseDescription.value.trim(),
                        amount: parseFloat(modalExpenseAmount.value)
                    };

                    if (!updatedExpense.date || !updatedExpense.category || isNaN(updatedExpense.amount) || updatedExpense.amount <= 0) {
                        showNotification('Mohon lengkapi semua data pengeluaran dengan benar.', 'warning');
                        return;
                    }

                    expenses[expenseIndex] = updatedExpense;
                    saveToLocalStorage(STORAGE_KEYS.EXPENSES, expenses);
                    renderExpenseList();
                    updateRecapSummary(); // Update recap summary
                    editExpenseModal.classList.remove('active');
                    showNotification('Pengeluaran berhasil diperbarui.', 'success');
                }
            });

            cancelExpenseEditBtn.addEventListener('click', () => {
                editExpenseModal.classList.remove('active');
                editingExpenseId = null;
            });


            // --- Laporan Penjualan Tab Logic ---
            const reportDateFilter = document.getElementById('report-date-filter');
            const transactionTableBody = document.getElementById('transaction-list-body');

            reportDateFilter.addEventListener('change', renderTransactionList);

            const renderTransactionList = () => {
                transactionTableBody.innerHTML = '';
                const filterMonth = reportDateFilter.value; // Format: Wochenende-MM

                const filteredTransactions = transactions.filter(trx => {
                    if (!filterMonth) return true; // No filter
                    return trx.date.startsWith(filterMonth);
                });

                if (filteredTransactions.length === 0) {
                    transactionTableBody.innerHTML = `<tr><td colspan="5" class="empty-table-message">Belum ada transaksi yang tercatat untuk periode ini.</td></tr>`;
                    return;
                }

                // Sort by date descending
                filteredTransactions.sort((a, b) => new Date(b.date) - new Date(a.date));

                filteredTransactions.forEach(trx => {
                    const row = document.createElement('tr');
                    const transactionDate = new Date(trx.date).toLocaleDateString('id-ID', {
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    row.innerHTML = `
                        <td>${trx.id}</td>
                        <td>${transactionDate}</td>
                        <td>${formatCurrency(trx.total)}</td>
                        <td>${formatCurrency(trx.discount)}</td>
                        <td class="table-actions">
                            <button class="info" data-id="${trx.id}" data-action="view-detail"><i data-feather="eye"></i> Detail</button>
                            <button class="danger" data-id="${trx.id}" data-action="delete-transaction"><i data-feather="trash-2"></i> Hapus</button>
                        </td>
                    `;
                    transactionTableBody.appendChild(row);
                });
                feather.replace(); // Re-render icons
            };

            transactionTableBody.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const transactionId = targetButton.dataset.id;
                const action = targetButton.dataset.action;

                if (action === 'view-detail') {
                    const transaction = transactions.find(t => t.id === transactionId);
                    if (transaction) {
                        showTransactionDetailModal(transaction);
                    }
                } else if (action === 'delete-transaction') {
                    if (confirm('Apakah Anda yakin ingin menghapus transaksi ini? Tindakan ini tidak dapat dibatalkan.')) {
                        transactions = transactions.filter(t => t.id !== transactionId);
                        saveToLocalStorage(STORAGE_KEYS.TRANSACTIONS, transactions);
                        renderTransactionList();
                        updateRecapSummary(); // Update recap summary
                        renderIncomeTrendChart(); // Update chart
                        showNotification('Transaksi berhasil dihapus.', 'info');
                    }
                }
            });

            // --- Transaction Detail Modal Logic ---
            const transactionDetailModal = document.getElementById('transactionDetailModal');
            const detailTransactionId = document.getElementById('detail-transaction-id');
            const detailTransactionDate = document.getElementById('detail-transaction-date');
            const detailTransactionItems = document.getElementById('detail-transaction-items');
            const detailTransactionSubtotal = document.getElementById('detail-transaction-subtotal');
            const detailTransactionDiscount = document.getElementById('detail-transaction-discount');
            const detailTransactionTotal = document.getElementById('detail-transaction-total');
            const detailTransactionPaid = document.getElementById('detail-transaction-paid');
            const detailTransactionChange = document.getElementById('detail-transaction-change');
            const closeDetailModalBtn = document.getElementById('close-detail-modal-btn');
            const printReceiptBtn = document.getElementById('print-receipt-btn');

            let currentTransactionForPrint = null; // To store transaction data for printing

            const showTransactionDetailModal = (transaction) => {
                currentTransactionForPrint = transaction; // Store for printing
                detailTransactionId.textContent = transaction.id;
                detailTransactionDate.textContent = new Date(transaction.date).toLocaleDateString('id-ID', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                detailTransactionItems.innerHTML = '';
                transaction.items.forEach(item => {
                    const li = document.createElement('li');
                    li.textContent = `${item.name} (${item.quantity} x ${formatCurrency(item.price)}) - ${formatCurrency(item.quantity * item.price)}`;
                    detailTransactionItems.appendChild(li);
                });
                detailTransactionSubtotal.textContent = formatCurrency(transaction.subtotal);
                detailTransactionDiscount.textContent = formatCurrency(transaction.discount);
                detailTransactionTotal.textContent = formatCurrency(transaction.total);
                detailTransactionPaid.textContent = formatCurrency(transaction.paid);
                detailTransactionChange.textContent = formatCurrency(transaction.change);
                transactionDetailModal.classList.add('active');
            };

            closeDetailModalBtn.addEventListener('click', () => {
                transactionDetailModal.classList.remove('active');
                currentTransactionForPrint = null;
            });

            printReceiptBtn.addEventListener('click', () => {
                if (!currentTransactionForPrint) {
                    showNotification('Tidak ada transaksi untuk dicetak.', 'warning');
                    return;
                }
                printReceipt(currentTransactionForPrint);
            });

            const printReceiptContentDiv = document.getElementById('printReceiptContent');
            const receiptLogoImg = document.getElementById('receipt-logo');

            const printReceipt = (transaction) => {
                printReceiptContentDiv.innerHTML = ''; // Clear previous content

                // Add logo if available
                if (receiptLogoUrl) {
                    receiptLogoImg.src = receiptLogoUrl;
                    receiptLogoImg.style.display = 'block';
                    // Clone parent div to include container styles, but ensure it's not the same element as the one in modal
                    const clonedLogoContainer = document.createElement('div');
                    clonedLogoContainer.className = 'receipt-logo-container';
                    const imgInPrint = document.createElement('img');
                    imgInPrint.id = 'receipt-logo-print'; // Unique ID for print version
                    imgInPrint.src = receiptLogoUrl;
                    imgInPrint.alt = "Company Logo";
                    imgInPrint.style.cssText = 'max-width: 100px; max-height: 80px; display: block; margin: 0 auto;'; // Apply styles directly
                    clonedLogoContainer.appendChild(imgInPrint);
                    printReceiptContentDiv.appendChild(clonedLogoContainer);
                } else {
                    // receiptLogoImg.style.display = 'none'; // Not needed if we clone and hide in print media query
                }

                const companyNameEl = document.createElement('div');
                companyNameEl.className = 'header';
                companyNameEl.innerHTML = `<h3>${companyName}</h3>`;
                printReceiptContentDiv.appendChild(companyNameEl);

                const trxInfo = document.createElement('div');
                trxInfo.className = 'header';
                trxInfo.innerHTML = `
                    <p><strong>ID Transaksi:</strong> ${transaction.id}</p>
                    <p><strong>Tanggal:</strong> ${new Date(transaction.date).toLocaleDateString('id-ID', { year: 'numeric', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' })}</p>
                `;
                printReceiptContentDiv.appendChild(trxInfo);

                const separator1 = document.createElement('div');
                separator1.className = 'separator';
                printReceiptContentDiv.appendChild(separator1);

                const itemsHeader = document.createElement('div');
                itemsHeader.className = 'item-row';
                itemsHeader.innerHTML = `<span class="item-name"><strong>Deskripsi</strong></span><span class="item-qty-price"><strong>Qty x Harga</strong></span><span class="text-right"><strong>Total</strong></span>`;
                printReceiptContentDiv.appendChild(itemsHeader);

                transaction.items.forEach(item => {
                    const itemRow = document.createElement('div');
                    itemRow.className = 'item-row';
                    itemRow.innerHTML = `
                        <span class="item-name">${item.name}</span>
                        <span class="item-qty-price">${item.quantity} x ${formatCurrency(item.price)}</span>
                        <span class="text-right">${formatCurrency(item.quantity * item.price)}</span>
                    `;
                    printReceiptContentDiv.appendChild(itemRow);
                });

                const separator2 = document.createElement('div');
                separator2.className = 'separator';
                printReceiptContentDiv.appendChild(separator2);

                const summaryDiv = document.createElement('div');
                summaryDiv.innerHTML = `
                    <div class="summary-row"><span>Subtotal:</span><span class="text-right">${formatCurrency(transaction.subtotal)}</span></div>
                    <div class="summary-row"><span>Diskon:</span><span class="text-right">${formatCurrency(transaction.discount)}</span></div>
                    <div class="summary-row total"><span>Total:</span><span class="text-right">${formatCurrency(transaction.total)}</span></div>
                    <div class="summary-row"><span>Dibayar:</span><span class="text-right">${formatCurrency(transaction.paid)}</span></div>
                    <div class="summary-row"><span>Kembalian:</span><span class="text-right">${formatCurrency(transaction.change)}</span></div>
                `;
                printReceiptContentDiv.appendChild(summaryDiv);

                const separator3 = document.createElement('div');
                separator3.className = 'separator';
                printReceiptContentDiv.appendChild(separator3);

                const footerDiv = document.createElement('div');
                footerDiv.className = 'footer';
                footerDiv.innerHTML = `
                    <p>Terima kasih atas kunjungan Anda!</p>
                    <p>Powered by Akuntansi Pintar</p>
                `;
                printReceiptContentDiv.appendChild(footerDiv);

                // Use html2pdf for better print control and PDF generation
                html2pdf().from(printReceiptContentDiv).set({
                    margin: [10, 10, 10, 10],
                    filename: `Struk_Transaksi_${transaction.id}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a7', orientation: 'portrait' } // A7 is a common receipt size
                }).save();

                // Fallback to browser print if html2pdf fails or for direct print
                // window.print();
            };


            // --- Rekapan Keuangan Tab Logic ---
            const recapRevenueSpan = document.getElementById('recap-revenue');
            const recapCostOfGoodsSpan = document.getElementById('recap-cost-of-goods');
            const recapTotalExpenseSpan = document.getElementById('recap-total-expense');
            const recapProfitSpan = document.getElementById('recap-profit');
            const incomeTrendChartCanvas = document.getElementById('incomeTrendChart');
            const chartFilterSelect = document.getElementById('chart-filter');
            const chartEmptyMessage = document.getElementById('chart-empty-message');

            const updateRecapSummary = () => {
                let totalRevenue = 0;
                let totalCostOfGoodsSold = 0;
                let totalExpenses = expenses.reduce((sum, exp) => sum + exp.amount, 0);

                transactions.forEach(trx => {
                    totalRevenue += trx.total;
                    trx.items.forEach(item => {
                        totalCostOfGoodsSold += item.quantity * item.costPrice;
                    });
                });

                const netProfit = totalRevenue - totalCostOfGoodsSold - totalExpenses;

                recapRevenueSpan.textContent = formatCurrency(totalRevenue);
                recapCostOfGoodsSpan.textContent = formatCurrency(totalCostOfGoodsSold);
                recapTotalExpenseSpan.textContent = formatCurrency(totalExpenses);
                recapProfitSpan.textContent = formatCurrency(netProfit);

                if (netProfit < 0) {
                    recapProfitSpan.style.color = 'var(--danger-color)';
                } else {
                    recapProfitSpan.style.color = 'var(--success-color)';
                }
            };

            chartFilterSelect.addEventListener('change', renderIncomeTrendChart);

            const renderIncomeTrendChart = () => {
                if (currentChart) {
                    currentChart.destroy(); // Destroy existing chart instance
                }

                if (transactions.length === 0) {
                    incomeTrendChartCanvas.style.display = 'none';
                    chartEmptyMessage.style.display = 'block';
                    return;
                } else {
                    incomeTrendChartCanvas.style.display = 'block';
                    chartEmptyMessage.style.display = 'none';
                }

                const filterType = chartFilterSelect.value;
                const dataMap = new Map();

                transactions.forEach(trx => {
                    const date = new Date(trx.date);
                    let key;

                    if (filterType === 'daily') {
                        key = date.toISOString().split('T')[0]; // YYYY-MM-DD
                    } else if (filterType === 'weekly') {
                        // Get week number and year
                        const year = date.getFullYear();
                        const firstDayOfYear = new Date(year, 0, 1);
                        const days = Math.floor((date - firstDayOfYear) / (24 * 60 * 60 * 1000));
                        const weekNumber = Math.ceil(days / 7);
                        key = `${year}-W${weekNumber < 10 ? '0' : ''}${weekNumber}`;
                    } else if (filterType === 'monthly') {
                        key = date.toISOString().substring(0, 7); // YYYY-MM
                    } else if (filterType === 'yearly') {
                        key = date.getFullYear().toString(); // YYYY
                    }

                    dataMap.set(key, (dataMap.get(key) || 0) + trx.total);
                });

                let labels = Array.from(dataMap.keys()).sort();
                let data = labels.map(key => dataMap.get(key));

                // Fill missing dates for daily/weekly/monthly for better trend visualization
                if (filterType === 'daily') {
                    const last30Days = [];
                    for (let i = 29; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - i);
                        last30Days.push(d.toISOString().split('T')[0]);
                    }
                    labels = last30Days;
                    data = last30Days.map(dateKey => dataMap.get(dateKey) || 0);
                } else if (filterType === 'weekly') {
                    const last12Weeks = [];
                    for (let i = 11; i >= 0; i--) {
                        const d = new Date();
                        d.setDate(d.getDate() - (i * 7)); // Go back by weeks
                        const year = d.getFullYear();
                        const firstDayOfYear = new Date(year, 0, 1);
                        const days = Math.floor((d - firstDayOfYear) / (24 * 60 * 60 * 1000));
                        const weekNumber = Math.ceil(days / 7);
                        last12Weeks.push(`${year}-W${weekNumber < 10 ? '0' : ''}${weekNumber}`);
                    }
                    labels = last12Weeks;
                    data = last12Weeks.map(weekKey => dataMap.get(weekKey) || 0);
                } else if (filterType === 'monthly') {
                     const last12Months = [];
                    for (let i = 11; i >= 0; i--) {
                        const d = new Date();
                        d.setMonth(d.getMonth() - i);
                        last12Months.push(d.toISOString().substring(0, 7));
                    }
                    labels = last12Months;
                    data = last12Months.map(monthKey => dataMap.get(monthKey) || 0);
                }


                const ctx = incomeTrendChartCanvas.getContext('2d');
                currentChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Pendapatan',
                            data: data,
                            borderColor: 'var(--primary-gold)',
                            backgroundColor: 'rgba(184, 134, 11, 0.2)',
                            fill: true,
                            tension: 0.3,
                            borderWidth: 2,
                            pointBackgroundColor: 'var(--primary-dark-gold)',
                            pointBorderColor: '#fff',
                            pointHoverBackgroundColor: '#fff',
                            pointHoverBorderColor: 'var(--primary-gold)'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                title: {
                                    display: true,
                                    text: filterType.charAt(0).toUpperCase() + filterType.slice(1)
                                },
                                grid: {
                                    display: false
                                }
                            },
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Jumlah Pendapatan (Rp)'
                                },
                                ticks: {
                                    callback: function(value) {
                                        return formatCurrency(value);
                                    }
                                }
                            }
                        },
                        plugins: {
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        let label = context.dataset.label || '';
                                        if (label) {
                                            label += ': ';
                                        }
                                        if (context.parsed.y !== null) {
                                            label += formatCurrency(context.parsed.y);
                                        }
                                        return label;
                                    }
                                }
                            }
                        }
                    }
                });
            };

            // --- Pengaturan Tab Logic ---
            const companyNameInput = document.getElementById('company-name-input');
            const saveCompanyNameBtn = document.getElementById('save-company-name-btn');
            const receiptLogoUrlInput = document.getElementById('receipt-logo-url-input');
            const saveReceiptLogoBtn = document.getElementById('save-receipt-logo-btn');
            const clearReceiptLogoBtn = document.getElementById('clear-receipt-logo-btn');
            const newUserNameInput = document.getElementById('new-user-username');
            const newUserPasswordInput = document.getElementById('new-user-password');
            const newUserRoleSelect = document.getElementById('new-user-role');
            const addNewUserBtn = document.getElementById('add-new-user-btn');
            const userListDisplay = document.getElementById('user-list-display');
            const exportProductsPdfBtn = document.getElementById('export-products-pdf-btn');
            const exportTransactionsPdfBtn = document.getElementById('export-transactions-pdf-btn');
            const exportExpensesPdfBtn = document.getElementById('export-expenses-pdf-btn');
            const exportRecapPdfBtn = document.getElementById('export-recap-pdf-btn');
            const exportChartPdfBtn = document.getElementById('export-chart-pdf-btn');
            const clearAllDataBtn = document.getElementById('clear-all-data-btn');
            const aboutUsLink = document.getElementById('about-us-link');
            const aboutUsModal = document.getElementById('aboutUsModal');
            const closeAboutUsModalBtn = document.getElementById('close-about-us-modal-btn');


            companyNameInput.value = companyName;
            receiptLogoUrlInput.value = receiptLogoUrl;

            saveCompanyNameBtn.addEventListener('click', () => {
                if (currentUser && currentUser.role !== 'admin') {
                    showNotification('Hanya admin yang bisa mengubah nama perusahaan.', 'error');
                    return;
                }
                const newName = companyNameInput.value.trim();
                if (newName) {
                    companyName = newName;
                    localStorage.setItem(STORAGE_KEYS.COMPANY_NAME, companyName);
                    updateCompanyNameDisplay();
                    showNotification('Nama perusahaan berhasil disimpan!', 'success');
                } else {
                    showNotification('Nama perusahaan tidak boleh kosong.', 'warning');
                }
            });

            saveReceiptLogoBtn.addEventListener('click', () => {
                if (currentUser && currentUser.role !== 'admin') {
                    showNotification('Hanya admin yang bisa mengubah logo struk.', 'error');
                    return;
                }
                const newUrl = receiptLogoUrlInput.value.trim();
                receiptLogoUrl = newUrl;
                localStorage.setItem(STORAGE_KEYS.RECEIPT_LOGO_URL, receiptLogoUrl);
                showNotification('URL logo struk berhasil disimpan!', 'success');
            });

            clearReceiptLogoBtn.addEventListener('click', () => {
                if (currentUser && currentUser.role !== 'admin') {
                    showNotification('Hanya admin yang bisa menghapus logo struk.', 'error');
                    return;
                }
                receiptLogoUrl = '';
                localStorage.removeItem(STORAGE_KEYS.RECEIPT_LOGO_URL);
                receiptLogoUrlInput.value = '';
                showNotification('Logo struk berhasil dihapus.', 'info');
            });

            // User Management
            addNewUserBtn.addEventListener('click', () => {
                if (currentUser && currentUser.role !== 'admin') {
                    showNotification('Hanya admin yang bisa menambah pengguna.', 'error');
                    return;
                }

                const username = newUserNameInput.value.trim();
                const password = newUserPasswordInput.value.trim();
                const role = newUserRoleSelect.value;

                if (!username || !password) {
                    showNotification('Username dan password tidak boleh kosong.', 'warning');
                    return;
                }
                if (users.some(u => u.username === username)) {
                    showNotification('Username sudah ada. Pilih username lain.', 'warning');
                    return;
                }

                users.push({ username, password, role });
                saveToLocalStorage(STORAGE_KEYS.USERS, users);
                renderUserList();
                showNotification(`Pengguna ${username} (${role}) berhasil ditambahkan.`, 'success');
                newUserNameInput.value = '';
                newUserPasswordInput.value = '';
                newUserRoleSelect.value = 'kasir';
            });

            const renderUserList = () => {
                userListDisplay.innerHTML = '';
                if (users.length <= 1 && users[0].username === 'admin') { // Only default admin
                    userListDisplay.innerHTML = `<p class="empty-table-message">Tidak ada pengguna lain. Admin default selalu ada.</p>`;
                    return;
                }

                const userTable = document.createElement('table');
                userTable.innerHTML = `
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Peran</th>
                            <th>Aksi</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                `;
                const tbody = userTable.querySelector('tbody');

                users.forEach(user => {
                    if (user.username === 'admin' && user.role === 'admin') return; // Don't allow deleting default admin

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${user.username}</td>
                        <td>${user.role}</td>
                        <td class="table-actions">
                            <button class="danger" data-username="${user.username}" data-action="delete-user"><i data-feather="trash-2"></i> Hapus</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                });
                userListDisplay.appendChild(userTable);
                feather.replace(); // Re-render icons
            };

            userListDisplay.addEventListener('click', (event) => {
                const targetButton = event.target.closest('button');
                if (!targetButton) return;

                const usernameToDelete = targetButton.dataset.username;
                const action = targetButton.dataset.action;

                if (action === 'delete-user') {
                    if (currentUser && currentUser.role !== 'admin') {
                        showNotification('Hanya admin yang bisa menghapus pengguna.', 'error');
                        return;
                    }
                    if (confirm(`Apakah Anda yakin ingin menghapus pengguna ${usernameToDelete}?`)) {
                        users = users.filter(u => u.username !== usernameToDelete);
                        saveToLocalStorage(STORAGE_KEYS.USERS, users);
                        renderUserList();
                        showNotification(`Pengguna ${usernameToDelete} berhasil dihapus.`, 'info');
                    }
                }
            });


            // Export to PDF functions
            exportProductsPdfBtn.addEventListener('click', () => {
                const element = document.getElementById('product-table');
                if (!element || products.length === 0) {
                    showNotification('Tidak ada data produk untuk diekspor.', 'warning');
                    return;
                }
                html2pdf().from(element).set({
                    margin: [10, 10, 10, 10],
                    filename: 'Laporan_Produk.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save();
                showNotification('Laporan produk berhasil diunduh.', 'info');
            });

            exportTransactionsPdfBtn.addEventListener('click', () => {
                const element = document.getElementById('transaction-table');
                if (!element || transactions.length === 0) {
                    showNotification('Tidak ada data transaksi untuk diekspor.', 'warning');
                    return;
                }
                html2pdf().from(element).set({
                    margin: [10, 10, 10, 10],
                    filename: 'Laporan_Penjualan.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } // Landscape for wider table
                }).save();
                showNotification('Laporan penjualan berhasil diunduh.', 'info');
            });

            exportExpensesPdfBtn.addEventListener('click', () => {
                const element = document.getElementById('expense-table');
                if (!element || expenses.length === 0) {
                    showNotification('Tidak ada data pengeluaran untuk diekspor.', 'warning');
                    return;
                }
                html2pdf().from(element).set({
                    margin: [10, 10, 10, 10],
                    filename: 'Laporan_Pengeluaran.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save();
                showNotification('Laporan pengeluaran berhasil diunduh.', 'info');
            });

            exportRecapPdfBtn.addEventListener('click', () => {
                const element = document.getElementById('recap-summary-content');
                if (!element) {
                    showNotification('Tidak ada data rekapan untuk diekspor.', 'warning');
                    return;
                }
                html2pdf().from(element).set({
                    margin: [10, 10, 10, 10],
                    filename: 'Rekapan_Keuangan.pdf',
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { scale: 2, logging: true, dpi: 192, letterRendering: true },
                    jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' }
                }).save();
                showNotification('Rekapan keuangan berhasil diunduh.', 'info');
            });

            exportChartPdfBtn.addEventListener('click', () => {
                const chartCanvas = document.getElementById('incomeTrendChart');
                if (!chartCanvas || transactions.length === 0) {
                    showNotification('Tidak ada data grafik untuk diekspor.', 'warning');
                    return;
                }

                // Get the image from the canvas
                const imageData = chartCanvas.toDataURL('image/png');

                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF({
                    orientation: 'landscape', // or 'portrait'
                    unit: 'mm',
                    format: 'a4'
                });

                const imgWidth = 280; // A4 landscape width approx 297mm - 17mm margin
                const imgHeight = (chartCanvas.height * imgWidth) / chartCanvas.width;

                pdf.addImage(imageData, 'PNG', 10, 10, imgWidth, imgHeight);
                pdf.save('Grafik_Pendapatan.pdf');
                showNotification('Grafik pendapatan berhasil diunduh.', 'info');
            });


            // Clear All Data
            clearAllDataBtn.addEventListener('click', () => {
                if (currentUser && currentUser.role !== 'admin') {
                    showNotification('Hanya admin yang bisa menghapus semua data.', 'error');
                    return;
                }
                if (confirm('PERINGATAN: Ini akan menghapus SEMUA data aplikasi Anda (produk, transaksi, pengeluaran, pengguna lain, pengaturan) dan tidak dapat dibatalkan. Lanjutkan?')) {
                    localStorage.clear();
                    // Reinitialize default admin user
                    users = [{ username: 'admin', password: 'admin123', role: 'admin' }];
                    saveToLocalStorage(STORAGE_KEYS.USERS, users);
                    // Clear other data in memory
                    products = [];
                    transactions = [];
                    expenses = [];
                    cart = [];
                    companyName = 'Akuntansi Pintar';
                    receiptLogoUrl = '';
                    currentUser = null; // Force re-login

                    showNotification('Semua data aplikasi berhasil dihapus. Silakan login ulang.', 'success', 5000);
                    // Reload page to reflect changes and show login modal
                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                }
            });

            // About Us Modal
            aboutUsLink.addEventListener('click', (e) => {
                e.preventDefault();
                aboutUsModal.classList.add('active');
            });

            closeAboutUsModalBtn.addEventListener('click', () => {
                aboutUsModal.classList.remove('active');
            });

            // Close modals when clicking outside or on close button
            document.querySelectorAll('.modal .close-button').forEach(button => {
                button.addEventListener('click', (e) => {
                    e.target.closest('.modal').classList.remove('active');
                });
            });

            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) { // Only close if clicking on the backdrop
                        modal.classList.remove('active');
                    }
                });
            });

            // --- Drag to Scroll for Tab Navigation and Cart Items ---
            const scrollableContainers = document.querySelectorAll('.scrollable-container');

            scrollableContainers.forEach(container => {
                let isDown = false;
                let startX;
                let scrollLeft;

                container.addEventListener('mousedown', (e) => {
                    isDown = true;
                    container.classList.add('active-drag');
                    startX = e.pageX - container.offsetLeft;
                    scrollLeft = container.scrollLeft;
                });
                container.addEventListener('mouseleave', () => {
                    isDown = false;
                    container.classList.remove('active-drag');
                });
                container.addEventListener('mouseup', () => {
                    isDown = false;
                    container.classList.remove('active-drag');
                });
                container.addEventListener('mousemove', (e) => {
                    if (!isDown) return;
                    e.preventDefault();
                    const x = e.pageX - container.offsetLeft;
                    const walk = (x - startX) * 1; // Adjust scroll speed
                    container.scrollLeft = scrollLeft - walk;
                });
            });


            // --- Initializations on Load ---
            const initializeApp = () => {
                updateCompanyNameDisplay();
                updateUserInfoDisplay();
                populateProductSelect();
                renderCart();
                renderProductList();
                renderExpenseList();
                renderTransactionList();
                updateRecapSummary();
                renderIncomeTrendChart(); // Initial chart render
                renderUserList(); // Render user list for admin

                // Check login status
                if (currentUser) {
                    loginModal.classList.remove('active');
                    updateTabVisibility();
                } else {
                    loginModal.classList.add('active');
                    updateTabVisibility();
                }
                feather.replace(); // Replace all feather icons on initial load
            };

            // Event listener for login button
            loginBtn.addEventListener('click', handleLogin);

            // Initial app setup
            initializeApp();
        });
    </script>
</body>
</html>
